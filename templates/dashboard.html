<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Signal Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0f17; --panel:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444; --accent:#3b82f6;
      --line:#1f2937;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Inter,sans-serif}
    header{display:flex;align-items:center;gap:12px;justify-content:space-between;padding:14px 16px;background:#0f1625;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:9}
    h1{margin:0;font-size:18px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:14px}
    .cols{grid-template-columns: 1.15fr 1fr}
    .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{background:#1f2a44;border:1px solid #24304f;color:#dbe7ff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.ok{background:rgba(22,163,74,.18);border-color:#1f5b35;color:#bff6cd}
    .btn.stop{background:rgba(239,68,68,.2);border-color:#5b1f27;color:#ffd0d0}
    .btn.ghost{background:transparent;border-color:var(--line);color:var(--muted)}
    input, select, textarea{
      background:#0c1322;border:1px solid #1d2741;color:var(--text);
      border-radius:10px;padding:8px 10px;outline:none
    }
    textarea{width:100%;min-height:70px;resize:vertical}
    label{display:inline-flex;align-items:center;gap:6px;margin:4px 10px 4px 0}
    small{color:var(--muted)}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;background:#18233b;color:#b9d1ff;font-size:12px;border:1px solid #223055}
    .kvs{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .kvs div{background:#0c1322;border:1px solid #1d2741;border-radius:10px;padding:8px}
    .flex{display:flex;gap:10px;align-items:center}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}
    .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}
    .section-title{font-weight:700;margin:0 0 8px 0}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .pill{padding:2px 6px;border-radius:8px;border:1px solid var(--line);background:#0d1526;color:#cbd5e1;font-size:12px}
    .list{max-height:220px;overflow:auto;border:1px solid #1d2741;border-radius:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #15203a}
    th{position:sticky;top:0;background:#111b2f;text-align:left}
    .flash{padding:8px 10px;border-radius:10px;margin:8px 0;border:1px solid #233154}
    .flash.ok{background:rgba(22,163,74,.16);border-color:#205837}
    .flash.error{background:rgba(239,68,68,.14);border-color:#6f2a2a}
    .flash.info{background:#0f1a31;border-color:#243456}
    .caps{display:flex;flex-wrap:wrap;gap:6px}
    .w100{width:100%}
    .nowrap{white-space:nowrap}
    .right{margin-left:auto}
    img.plot{width:100%;border:1px solid #172342;border-radius:12px;background:#0b0f17}
    .checkbox-col{columns:3}
    @media (max-width:1100px){ .cols{grid-template-columns:1fr} .checkbox-col{columns:2} }
    @media (max-width:640px){ .checkbox-col{columns:1} }
    pre.code{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;background:#0b1220;border:1px solid #1e293b;border-radius:10px;padding:10px}
  </style>
</head>
<body>

<header>
  <div class="row">
    <h1>Signal Dashboard</h1>
    <span class="muted">TZ: {{ tz }}</span>
    <span class="tag">{{ now_local }}</span>
    {% if window_ok %}<span class="tag">Window OK</span>{% else %}<span class="tag">Outside Window</span>{% endif %}
  </div>
  <div class="row">
    {% if view == 'login' %}
      <span class="muted">Login required</span>
    {% else %}
      <form action="{{ url_for('dashboard.logout') }}" method="get"><button class="btn ghost">Logout</button></form>
    {% endif %}
  </div>
</header>

<div class="grid" style="padding:14px">

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="flash {{ 'ok' if cat=='ok' else ('error' if cat=='error' else 'info') }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% if view == 'login' %}
    <div class="panel" style="max-width:520px;margin:40px auto">
      <h3 class="section-title">Admin Login</h3>
      <form action="{{ url_for('dashboard.login') }}" method="post" class="grid">
        <input type="password" name="password" placeholder="Password" required />
        <button class="btn ok">Login</button>
      </form>
      <div class="mt12"><small class="muted">Default password is "admin" (env: ADMIN_PASSWORD).</small></div>
    </div>
  {% else %}

  <div class="grid cols">
    <div class="panel">
      <div class="row">
        <strong>Live Engine</strong>
        <span class="pill">Running: <span id="st_running">{{ 'true' if engine.get('running') else 'false' }}</span></span>
        <span class="pill">Debug: <span id="st_debug">{{ 'true' if engine.get('debug') else 'false' }}</span></span>
        <span class="pill">Loop Sleep: <span id="st_sleep">{{ engine.get('loop_sleep',4) }}</span>s</span>
        <span class="pill">Total: <span id="st_total">{{ (engine.get('tally') or {}).get('total', 0) }}</span></span>
        <button id="btnStart" class="btn ok">Start</button>
        <button id="btnStop" class="btn stop">Stop</button>
        <button id="btnDbgOn" class="btn">Debug ON</button>
        <button id="btnDbgOff" class="btn">Debug OFF</button>
        <span class="right muted" id="statusHint"></span>
      </div>
      <div class="divider"></div>
      <div class="kvs">
        <div><small>Configured chats</small><div class="caps">
          {% for tier, cid in (tier_to_chat or {}).items() %}
            <span class="tag">{{ tier }}: {{ 'yes' if cid else 'no' }}</span>
          {% endfor %}
        </div></div>
        <div><small>Daily caps</small><div class="caps">
          {% for tier, cap in (daily_caps or {}).items() %}
            <span class="tag">{{ tier }}: {{ cap if cap is not none else '‚àû' }}</span>
          {% endfor %}
        </div></div>
      </div>
    </div>

    <div class="panel">
      <strong>Quick Telegram Broadcast</strong>
      <form id="frmSend" class="mt8 row" onsubmit="return sendBroadcast(event)">
        <select name="tier">
          <option value="all">All tiers</option>
          <option value="free">free</option>
          <option value="basic">basic</option>
          <option value="pro">pro</option>
          <option value="vip">vip</option>
        </select>
        <input class="w100" name="text" placeholder="Type a message to broadcast‚Ä¶" />
        <button class="btn ok">Send</button>
        <button class="btn" type="button" onclick="testAll()">Test All</button>
      </form>
      <div id="sendResult" class="mt8 muted"></div>
    </div>
  </div>

  <div class="grid cols">
    <div class="panel">
      <form action="{{ url_for('dashboard.view') }}" method="post">
        <h3 class="section-title">1) Symbols / Pairs & Defaults</h3>
        <div class="mb8"><small class="muted">Select majors and/or add your own. Use ‚ÄúConvert PO‚ÜíDeriv‚Äù to map PocketOption symbols to Deriv (frx‚Ä¶)</small></div>

        <div class="checkbox-col mb12">
          {% set majors = ["EURUSD","GBPUSD","USDJPY","USDCHF","USDCAD","AUDUSD","NZDUSD","EURGBP","EURJPY","GBPJPY","EURAUD","AUDJPY","CADJPY","CHFJPY"] %}
          {% for po in majors %}
            <label><input type="checkbox" name="pair_{{ po }}"> {{ po }}</label>
          {% endfor %}
        </div>

        <div class="split">
          <div>
            <label class="w100">Manual symbols (space or comma separated)
              <textarea name="symbols_text" placeholder="frxEURUSD frxGBPUSD ...">{{ ' '.join(cfg.get('symbols_raw', [])) }}</textarea>
            </label>
            <label><input type="checkbox" name="convert_po" checked> Convert PO‚ÜíDeriv</label>
          </div>
          <div>
            <div class="row">
              <label>Live TF
                <select name="live_tf">
                  {% for tf in ["M1","M2","M3","M5","M10","M15","M30","H1","H4","D1"] %}
                    <option value="{{ tf }}" {{ 'selected' if cfg.get('live_tf')==tf else '' }}>{{ tf }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>Live Expiry
                <select name="live_expiry">
                  {% for e in ["1m","3m","5m","10m","30m","1h","4h"] %}
                    <option value="{{ e }}" {{ 'selected' if cfg.get('live_expiry')==e else '' }}>{{ e }}</option>
                  {% endfor %}
                </select>
              </label>
            </div>
            <div class="row">
              <label>Window Start <input name="window_start" value="{{ (cfg.get('window') or {}).get('start','08:00') }}" placeholder="08:00"></label>
              <label>Window End <input name="window_end" value="{{ (cfg.get('window') or {}).get('end','17:00') }}" placeholder="17:00"></label>
              <label>TZ <input name="window_tz" value="{{ (cfg.get('window') or {}).get('timezone', tz) }}"></label>
            </div>
            <div class="row">
              <label><input type="checkbox" name="use_deriv_fetch" {{ 'checked' if cfg.get('use_deriv_fetch') else '' }}> Use Deriv fetch</label>
              <label>Count <input type="number" name="deriv_count" value="{{ cfg.get('deriv_count',300) }}" min="60" step="60" style="width:110px"></label>
            </div>
          </div>
        </div>

        <div class="divider"></div>
        <h3 class="section-title">2) Strategies & Custom Rules</h3>
        <div class="row">
          {% for s in ["BASE","TREND","CHOP","CUSTOM1","CUSTOM2","CUSTOM3"] %}
            <label><input type="checkbox" name="s_{{ s }}" {{ 'checked' if (cfg.get('strategies',{}).get(s,{}).get('enabled')) else '' }}> {{ s }}</label>
          {% endfor %}
        </div>
        <div class="split mt8">
          <label>CUSTOM 1 rules<textarea name="custom1_rules" placeholder="human rules or JSON‚Ä¶">{{ cfg.get('custom1_rules','') }}</textarea></label>
          <label>CUSTOM 2 rules<textarea name="custom2_rules">{{ cfg.get('custom2_rules','') }}</textarea></label>
        </div>
        <div class="mt8">
          <label>CUSTOM 3 rules<textarea name="custom3_rules">{{ cfg.get('custom3_rules','') }}</textarea></label>
        </div>

        <div class="divider"></div>
        <h3 class="section-title">3) Indicators (form save)</h3>
        <div class="grid" style="grid-template-columns:repeat(2,minmax(0,1fr))">
          {% for key, spec in ind_specs.items() %}
            {% set block = (cfg.get('indicators') or {}).get(key, {}) %}
            <div class="panel" style="padding:10px">
              <div class="row">
                <label><input type="checkbox" name="ind_{{ key }}" {{ 'checked' if block.get('enabled') else '' }}> <strong>{{ spec.title }}</strong></label>
                <span class="pill">{{ spec.panel }}</span>
                <span class="muted right">{{ key }}</span>
              </div>
              {% if spec.fields %}
                <div class="row mt8" style="flex-wrap:wrap">
                  {% for fname, default in spec.fields.items() %}
                    <label class="nowrap">{{ fname }}
                      <input style="width:120px" name="ind_{{ key }}_{{ fname }}" value="{{ block.get(fname, default) }}">
                    </label>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>

        <div class="mt12 row">
          <button class="btn ok">Save All</button>
          <span class="muted">Saved in SQLite.</span>
        </div>
      </form>
    </div>

    <div class="grid" style="gap:14px">

      <div class="panel">
        <h3 class="section-title">Indicators ‚Äî Live API (per-indicator)</h3>
        <div class="muted">Toggle quickly and update params without full form save.</div>
        <div id="indList">
          {% for key, spec in ind_specs.items() %}
          {% set state = (cfg.get("indicators",{}).get(key, {})) %}
          <div class="panel" style="padding:10px;margin-top:10px">
            <div class="row">
              <strong>{{ spec.title }}</strong>
              <span class="pill">{{ key }}</span>
              <span class="pill">{{ spec.panel }}</span>
              <label class="right"><input type="checkbox" data-ind-toggle="{{key}}" {% if state.get('enabled') %}checked{% endif %}/> enabled</label>
            </div>
            {% if spec.fields %}
            <form class="row mt8" onsubmit="return saveParams(event,'{{key}}')">
              {% for fname, default in spec.fields.items() %}
                <label>{{fname}} <input name="{{fname}}" style="width:100px" value="{{ state.get(fname, default) }}"></label>
              {% endfor %}
              <button class="btn">Save Params</button>
            </form>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>

      <div class="panel">
        <h3 class="section-title">Quick API ‚Äì ALL Indicators</h3>
        <div class="row">
          <button class="btn" onclick="toggleAllIndicators(true)">Enable All</button>
          <button class="btn" onclick="toggleAllIndicators(false)">Disable All</button>
          <button class="btn stop" onclick="resetAllIndicators()">Reset All</button>
          <span id="qaAllMsg" class="muted"></span>
        </div>
        <div class="mt8">Bulk Params (applied to any indicator that has that field):</div>
        <form class="row" onsubmit="return bulkParamsAll(event)">
          <textarea class="w100" name="params_text" placeholder="period=14
mult=2
step=0.02
max=0.2"></textarea>
          <button class="btn">Apply</button>
        </form>
        <div class="divider"></div>
        <details>
          <summary class="muted">Show API examples</summary>
<pre class="code">
# Enable all
curl -X POST "{{ url_for('dashboard.api_ind_toggle_all') }}" -H "Content-Type: application/json" -d '{"enabled": true}'

# Disable all
curl -X POST "{{ url_for('dashboard.api_ind_toggle_all') }}" -H "Content-Type: application/json" -d '{"enabled": false}'

# Bulk params for all (only existing fields updated)
curl -X POST "{{ url_for('dashboard.api_ind_params_all') }}" -H "Content-Type: application/json" -d '{"params":{"period":14,"mult":2,"step":0.02,"max":0.2}}'

# Reset all to defaults
curl -X POST "{{ url_for('dashboard.api_ind_reset_all') }}"
</pre>
        </details>
        <div class="mt8">
          <button class="btn" onclick="loadAllState()">Refresh State</button>
        </div>
        <pre id="qaAllState" class="code" style="margin-top:8px"></pre>
      </div>

    </div>
  </div>

  <div class="panel">
    <h3 class="section-title">Backtest</h3>
    <form id="frmBT" onsubmit="return runBacktest(event)" enctype="multipart/form-data">
      <div class="row">
        <label>TF
          <select name="bt_tf">
            {% for tf in ["M1","M2","M3","M5","M10","M15","M30","H1","H4","D1"] %}
              <option value="{{ tf }}" {{ 'selected' if cfg.get('live_tf')==tf else '' }}>{{ tf }}</option>
            {% endfor %}
          </select>
        </label>
        <label>Expiry
          <select name="bt_expiry">
            {% for e in ["1m","3m","5m","10m","30m","1h","4h"] %}
              <option value="{{ e }}" {{ 'selected' if cfg.get('live_expiry')==e else '' }}>{{ e }}</option>
            {% endfor %}
          </select>
        </label>
        <label>Count <input type="number" name="bt_count" value="{{ cfg.get('deriv_count',300) }}" min="60" step="60" style="width:110px"></label>
        <label><input type="checkbox" name="use_deriv_fetch" {{ 'checked' if cfg.get('use_deriv_fetch') else '' }}> Use Deriv</label>
      </div>
      <div class="mt8">
        <input class="w100" name="bt_symbols" placeholder="Optional override: symbols (comma or space) e.g. frxEURUSD,frxGBPUSD" />
        <label class="mt8"><input type="checkbox" name="convert_po_bt" checked> Convert PO‚ÜíDeriv (for the above box)</label>
      </div>
      <div class="row mt8">
        <label>CSV (optional) <input type="file" name="bt_csv" accept=".csv"></label>
        <label>Strategy
          <select name="bt_strategy">
            {% for s in ["BASE","TREND","CHOP","CUSTOM1","CUSTOM2","CUSTOM3"] %}
              <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
        </label>
        <button class="btn ok">Run</button>
      </div>
    </form>
    <div id="btSummary" class="mt8 muted"></div>
    <img id="btPlot" class="plot mt8" style="display:none" alt="Backtest Plot" />
  </div>

  <div class="grid cols">
    <div class="panel">
      <h3 class="section-title">Telegram Users</h3>
      <form action="{{ url_for('dashboard.users_add') }}" method="post" class="row">
        <select name="tier">
          {% for t in ["free","basic","pro","vip"] %}
            <option value="{{ t }}">{{ t }}</option>
          {% endfor %}
        </select>
        <input name="chat_id" placeholder="chat_id" required />
        <input name="label" placeholder="label (optional)" />
        <button class="btn ok">Add</button>
      </form>
      <div class="list mt8">
        <table>
          <thead><tr><th>ID</th><th>Tier</th><th>Chat</th><th>Label</th><th></th></tr></thead>
          <tbody>
            {% for r in users %}
              <tr>
                <td>{{ r[0] }}</td>
                <td>{{ r[1] }}</td>
                <td class="nowrap">{{ r[2] }}</td>
                <td>{{ r[3] or '' }}</td>
                <td>
                  <form action="{{ url_for('dashboard.users_delete') }}" method="post"
                        onsubmit="return confirm('Delete user #{{ r[0] }}?')">
                    <input type="hidden" name="id" value="{{ r[0] }}">
                    <button class="btn stop">Delete</button>
                  </form>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="5" class="muted">No users yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="panel">
      <h3 class="section-title">Engine Snapshot</h3>
      <button class="btn" onclick="refreshStatus()">Refresh</button>
      <div class="mt8"></div>
      <pre id="statusJson" class="code">{{ engine | tojson(indent=2) }}</pre>
    </div>
  </div>

  {% endif %}
</div>

<script>
const q = (sel,root=document)=>root.querySelector(sel);
const statusHint = q('#statusHint');

async function postJSON(url, body){
  const r = await fetch(url, {
    method:'POST',
    headers: body instanceof FormData ? {} : {'Content-Type':'application/json'},
    body: body instanceof FormData ? body : JSON.stringify(body||{})
  });
  const js = await r.json().catch(()=>({ok:false,error:'Bad JSON'}));
  return js;
}

// ---------- Live Engine buttons ----------
q('#btnStart')?.addEventListener('click', async ()=>{
  statusHint.textContent='Starting‚Ä¶';
  const js = await postJSON('{{ url_for("dashboard.live_start") }}', {});
  statusHint.textContent = js.ok ? 'Started' : ('Failed: ' + (js.msg||''));
  refreshStatus();
});

q('#btnStop')?.addEventListener('click', async ()=>{
  statusHint.textContent='Stopping‚Ä¶';
  const js = await postJSON('{{ url_for("dashboard.live_stop") }}', {});
  statusHint.textContent = js.ok ? 'Stopped' : ('Failed: ' + (js.msg||''));
  refreshStatus();
});

q('#btnDbgOn')?.addEventListener('click', async ()=>{
  await postJSON('{{ url_for("dashboard.live_debug_on") }}', {}); refreshStatus();
});
q('#btnDbgOff')?.addEventListener('click', async ()=>{
  await postJSON('{{ url_for("dashboard.live_debug_off") }}', {}); refreshStatus();
});

async function refreshStatus(){
  try{
    const r = await fetch('{{ url_for("dashboard.api_status_dup") }}');
    const s = await r.json();
    q('#st_running').textContent = s.running ? 'true' : 'false';
    q('#st_debug').textContent   = s.debug ? 'true' : 'false';
    q('#st_sleep').textContent   = s.loop_sleep ?? 4;
    q('#st_total').textContent   = (s.tally && s.tally.total) ? s.tally.total : (s.tallies?.all ?? 0);
    const pre = q('#statusJson'); if(pre){ pre.textContent = JSON.stringify(s,null,2); }
  }catch(e){}
}

// ---------- Backtest ----------
async function runBacktest(ev){
  ev.preventDefault();
  const f = ev.target;
  const fd = new FormData(f);
  const btn = f.querySelector('button[type=submit],button');
  if(btn){ btn.disabled = true; btn.textContent = 'Running‚Ä¶'; }
  q('#btSummary').textContent = '';
  q('#btPlot').style.display='none';
  try{
    const r = await fetch('{{ url_for("dashboard.backtest") }}', { method:'POST', body: fd });
    const js = await r.json();
    if(js.ok){
      if(js.stats){
        const st = js.stats;
        q('#btSummary').textContent = `${st.wins||0}W / ${st.loss||0}L / ${st.draw||0}D ‚Äî WR ${(st.win_rate||0).toFixed(1)}%`;
      }
      if(js.plot){
        const img = q('#btPlot');
        img.src = js.plot + (js.plot.includes('?') ? '&' : '?') + 't=' + Date.now();
        img.style.display = '';
      }
    }else{
      q('#btSummary').textContent = 'Error: ' + (js.error || 'Unknown');
    }
  }catch(e){
    q('#btSummary').textContent = 'Error: ' + e;
  }finally{
    if(btn){ btn.disabled=false; btn.textContent='Run'; }
  }
  return false;
}

// ---------- Telegram send / test ----------
async function sendBroadcast(ev){
  ev.preventDefault();
  const f = ev.target;
  const fd = new FormData(f);
  q('#sendResult').textContent = 'Sending‚Ä¶';
  try{
    const r = await fetch('{{ url_for("dashboard.telegram_send") }}', { method:'POST', body: fd });
    const js = await r.json();
    q('#sendResult').textContent = js.ok ? 'Sent ‚úî' : ('Error: ' + (js.error || 'Unknown'));
  }catch(e){
    q('#sendResult').textContent = 'Error: ' + e;
  }
  return false;
}

async function testAll(){
  q('#sendResult').textContent = 'Testing‚Ä¶';
  try{
    const fd = new FormData();
    fd.set('text','üß™ Dashboard test');
    const r = await fetch('{{ url_for("dashboard.telegram_test") }}', { method:'POST', body: fd });
    const js = await r.json();
    q('#sendResult').textContent = js.ok ? 'Test sent to all tiers ‚úî' : 'Test failed';
  }catch(e){
    q('#sendResult').textContent = 'Error: ' + e;
  }
}

// ---------- Indicators (live per-indicator) ----------
document.querySelectorAll('[data-ind-toggle]').forEach(cb=>{
  cb.addEventListener('change', async (e)=>{
    const key = e.target.getAttribute('data-ind-toggle');
    try{
      const js = await fetch('{{ url_for("dashboard.api_ind_toggle") }}', {
        method:'POST',
        headers:{'Content-Type':'text/plain'},
        body: `${key}:${e.target.checked?'ON':'OFF'}`
      }).then(r=>r.json());
      if(!js.ok){ throw new Error(js.error||'Toggle failed'); }
    }catch(err){
      alert('Failed: '+err.message);
      e.target.checked = !e.target.checked; // revert
    }
  });
});

async function saveParams(ev, key){
  ev.preventDefault();
  const fd = new FormData(ev.target);
  let body = key + "\n";
  for (const [k,v] of fd.entries()) body += `${k}=${v}\n`;
  try{
    const js = await fetch('{{ url_for("dashboard.api_ind_params") }}', {
      method:'POST',
      headers:{'Content-Type':'text/plain'},
      body
    }).then(r=>r.json());
    if(!js.ok){ throw new Error(js.error||'Save failed'); }
  }catch(err){
    alert('Save failed: '+err.message);
  }
  return false;
}

// ---------- ALL indicators quick controls ----------
async function toggleAllIndicators(on){
  const el = document.getElementById('qaAllMsg');
  el.textContent = on ? 'Enabling all‚Ä¶' : 'Disabling all‚Ä¶';
  try{
    const js = await fetch('{{ url_for("dashboard.api_ind_toggle_all") }}', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({enabled: !!on})
    }).then(r=>r.json());
    el.textContent = js.ok ? 'Done.' : ('Error: ' + (js.error || 'unknown'));
    loadAllState();
  }catch(e){ el.textContent = 'Error: ' + e.message; }
}
async function resetAllIndicators(){
  const el = document.getElementById('qaAllMsg');
  if(!confirm('Reset ALL indicators to defaults?')) return;
  el.textContent = 'Resetting‚Ä¶';
  try{
    const js = await fetch('{{ url_for("dashboard.api_ind_reset_all") }}', { method:'POST' }).then(r=>r.json());
    el.textContent = js.ok ? 'Reset complete.' : ('Error: ' + (js.error || 'unknown'));
    loadAllState();
  }catch(e){ el.textContent = 'Error: ' + e.message; }
}
async function bulkParamsAll(ev){
  ev.preventDefault();
  const el = document.getElementById('qaAllMsg');
  el.textContent = 'Applying params to all‚Ä¶';
  const fd = new FormData(ev.target);
  const lines = (fd.get('params_text') || '').toString();
  try{
    const js = await fetch('{{ url_for("dashboard.api_ind_params_all") }}', {
      method:'POST', headers:{'Content-Type':'text/plain'}, body: lines
    }).then(r=>r.json());
    el.textContent = js.ok ? 'Applied.' : ('Error: ' + (js.error || 'unknown'));
    loadAllState();
  }catch(e){ el.textContent = 'Error: ' + e.message; }
  return false;
}
async function loadAllState(){
  try{
    const js = await fetch('{{ url_for("dashboard.api_indicators") }}').then(r=>r.json());
    document.getElementById('qaAllState').textContent = JSON.stringify(js.state, null, 2);
  }catch(e){
    document.getElementById('qaAllState').textContent = 'Error: ' + e.message;
  }
}
loadAllState();

// Poll status every 10s
setInterval(refreshStatus, 10000);
</script>
</body>
</html>
