<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Signals Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root {
    --bg: #0b0f17; --panel: #101826; --muted: #6b7280; --text: #e5e7eb; --accent:#22c55e; --warn:#f59e0b; --err:#ef4444; --line:#1f2937;
  }
  html, body { background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif; }
  a { color: #93c5fd; text-decoration: none; }
  .wrap { max-width: 1200px; margin: 0 auto; padding: 18px; }
  .grid { display: grid; gap: 16px; }
  .g2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  .g3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
  @media (max-width: 960px){ .g2,.g3 { grid-template-columns: 1fr; } }
  .card { background: var(--panel); border: 1px solid var(--line); border-radius: 14px; padding: 14px 16px; }
  .card h3 { margin: 0 0 8px; font-size: 18px; }
  .card h4 { margin: 12px 0 8px; font-size: 15px; color: #cbd5e1; }
  .muted { color: var(--muted); }
  .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
  .btn { background: #1f2937; color: var(--text); border: 1px solid var(--line); padding: 8px 12px; border-radius: 10px; cursor: pointer; }
  .btn.primary { background: #2563eb; border-color: #1d4ed8; }
  .btn.success { background: var(--accent); color: #052e16; border: none; }
  .btn.warn { background: var(--warn); color: #3b1d00; border: none; }
  .btn.danger { background: var(--err); color: #3b0d0d; border: none; }
  .btn:disabled { opacity: .6; cursor: not-allowed; }
  label { display: inline-flex; align-items: center; gap: 6px; }
  input[type="text"], input[type="number"], select, textarea { width: 100%; background: #0b1220; color: var(--text); border: 1px solid var(--line); border-radius: 10px; padding: 8px 10px; }
  input[type="checkbox"] { transform: translateY(1px); }
  textarea { min-height: 70px; }
  .kvs { display: grid; grid-template-columns: max-content 1fr; gap: 6px 12px; align-items: center; }
  .hr { height: 1px; background: var(--line); margin: 10px 0; }
  .pill { display: inline-block; padding: 4px 8px; border-radius: 999px; background: #0f172a; border: 1px solid var(--line); font-size: 12px; }
  .tag { display: inline-block; padding: 2px 6px; border-radius: 6px; background: #0f172a; border: 1px solid var(--line); font-size: 12px; }
  img.plot { width: 100%; border-radius: 12px; border: 1px solid var(--line); background: #0b0f17; }
  pre { background: #0b1220; color: #cbd5e1; padding: 10px; border-radius: 12px; border: 1px solid var(--line); overflow: auto; }
  .cols-3 { columns: 3; column-gap: 16px; }
  @media (max-width: 1100px){ .cols-3 { columns: 2; } }
  @media (max-width: 800px){ .cols-3 { columns: 1; } }
  .pair-box { break-inside: avoid; margin-bottom: 8px; }
  .toast { padding: 8px 10px; border-radius: 10px; background: #0b1220; border:1px solid var(--line); }
  .ok { border-color: #14532d; }
  .err { border-color: #7f1d1d; }
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content: space-between;">
    <div>
      <h2 style="margin:0;">Signals Dashboard</h2>
      <div class="muted">Local: {{ now_local }} • TZ: {{ tz }} • Window OK: <span class="pill">{{ 'YES' if window_ok else 'NO' }}</span></div>
    </div>
    <div class="row">
      {% if session.admin %}
        <form action="{{ url_for('dashboard.logout') }}" method="get"><button class="btn">Logout</button></form>
      {% else %}
        <form action="{{ url_for('dashboard.login') }}" method="post" class="row">
          <input type="password" name="password" placeholder="Admin password">
          <button class="btn">Login</button>
        </form>
      {% endif %}
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="grid" style="margin-top:12px;">
      {% for cat, msg in messages %}
        <div class="toast {{ 'ok' if cat=='ok' else 'err' if cat=='error' else '' }}">{{ msg }}</div>
      {% endfor %}
    </div>
  {% endif %}
  {% endwith %}

  {% if session.admin %}
  <form id="mainForm" action="{{ url_for('dashboard.view') }}" method="post">
    <div class="grid g2" style="margin-top:14px;">
      <!-- Settings -->
      <div class="card">
        <h3>General Settings</h3>
        <div class="kvs">
          <div>Window (Mon–Fri):</div>
          <div class="row" style="gap:6px;">
            <input type="text" name="window_start" value="{{ cfg.window.start if cfg.window else '08:00' }}" style="max-width:110px">
            <span class="muted">to</span>
            <input type="text" name="window_end" value="{{ cfg.window.end if cfg.window else '17:00' }}" style="max-width:110px">
            <input type="text" name="window_tz" value="{{ tz }}" style="max-width:220px">
          </div>

          <div>Live TF / Expiry:</div>
          <div class="row" style="gap:6px;">
            <select name="live_tf" style="max-width:130px">
              {% for tf in ['M1','M2','M3','M5','M10','M15','M30','H1','H4','D1'] %}
                <option value="{{ tf }}" {{ 'selected' if cfg.live_tf==tf else '' }}>{{ tf }}</option>
              {% endfor %}
            </select>
            <select name="live_expiry" style="max-width:130px">
              {% for e in ['1m','3m','5m','10m','30m','1h','4h'] %}
                <option value="{{ e }}" {{ 'selected' if cfg.live_expiry==e else '' }}>{{ e }}</option>
              {% endfor %}
            </select>
          </div>

          <div>Deriv Fetch:</div>
          <div class="row" style="gap:6px;">
            <label><input type="checkbox" name="use_deriv_fetch" {{ 'checked' if cfg.use_deriv_fetch else '' }}> Use Deriv server fetch</label>
            <input type="number" name="deriv_count" min="60" step="1" value="{{ cfg.deriv_count or 300 }}" style="max-width:120px">
          </div>
        </div>
        <div class="hr"></div>

        <h4>Pairs (PO majors) + Manual Symbols</h4>
        <div class="cols-3" id="poPairs">
          {% set majors = ['EURUSD','GBPUSD','USDJPY','USDCHF','USDCAD','AUDUSD','NZDUSD','EURGBP','EURJPY','GBPJPY','EURAUD','AUDJPY','CADJPY','CHFJPY'] %}
          {% for po in majors %}
            <div class="pair-box"><label><input type="checkbox" class="po-check" value="{{ po }}"> {{ po }}</label></div>
          {% endfor %}
        </div>
        <div class="row" style="margin-top:8px;">
          <label><input type="checkbox" id="convertPO" name="convert_po" {{ 'checked' if False else '' }}> Convert PO → Deriv (frx…)</label>
        </div>
        <div style="margin-top:8px;">
          <textarea id="symbols_text" name="symbols_text" placeholder="Manual symbols (space or comma separated)">{{ ' '.join(cfg.symbols_raw or []) }}</textarea>
          <div class="muted" style="margin-top:4px;">Hint: You can type PO (e.g. EURUSD) or Deriv codes (e.g. frxEURUSD). If any PO majors are present, the Convert box will auto-toggle.</div>
        </div>
        <div class="row" style="margin-top:10px; justify-content:flex-end;">
          <button type="submit" class="btn success">Save Settings</button>
        </div>
      </div>

      <!-- Strategies & Custom Rules -->
      <div class="card">
        <h3>Strategies</h3>
        <div class="row" style="gap:12px; flex-wrap: wrap;">
          {% for name in ['BASE','TREND','CHOP','CUSTOM1','CUSTOM2','CUSTOM3'] %}
            <label class="tag"><input type="checkbox" name="s_{{ name }}" {{ 'checked' if cfg.strategies.get(name,{}).get('enabled') else '' }}> {{ name }}</label>
          {% endfor %}
        </div>
        <h4 style="margin-top:12px;">Custom Rules</h4>
        <div class="grid g3">
          <div>
            <div class="muted">CUSTOM1</div>
            <textarea name="custom1_rules" placeholder="Write simple rules / notes…">{{ cfg.custom1_rules or '' }}</textarea>
          </div>
          <div>
            <div class="muted">CUSTOM2</div>
            <textarea name="custom2_rules" placeholder="Write simple rules / notes…">{{ cfg.custom2_rules or '' }}</textarea>
          </div>
          <div>
            <div class="muted">CUSTOM3</div>
            <textarea name="custom3_rules" placeholder="Write simple rules / notes…">{{ cfg.custom3_rules or '' }}</textarea>
          </div>
        </div>
        <div class="row" style="margin-top:10px; justify-content:flex-end;">
          <button type="submit" class="btn">Save Strategies/Rules</button>
        </div>
      </div>
    </div>

    <!-- Indicators -->
    <div class="card" style="margin-top:16px;">
      <h3>Indicators</h3>
      <div class="grid g3">
        {% for key, spec in ind_specs.items() %}
          {% set block = cfg.indicators.get(key, {}) %}
          <div class="card" style="padding:10px;">
            <div class="row" style="justify-content:space-between;">
              <div><strong>{{ spec.title }}</strong> <span class="muted">({{ key }})</span></div>
              <label><input type="checkbox" name="ind_{{ key }}" {{ 'checked' if block.enabled else '' }}> Enabled</label>
            </div>
            {% if spec.fields %}
              <div class="kvs" style="margin-top:6px;">
                {% for fname, default in spec.fields.items() %}
                  <div class="muted">{{ fname }}</div>
                  <div><input type="text" name="ind_{{ key }}_{{ fname }}" value="{{ block.get(fname, default) }}"></div>
                {% endfor %}
              </div>
            {% else %}
              <div class="muted" style="margin-top:6px;">No parameters</div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
      <div class="row" style="margin-top:10px; justify-content:flex-end;">
        <button type="submit" class="btn">Save Indicators</button>
      </div>
    </div>
  </form>

  <!-- Backtest & Plot -->
  <div class="grid g2" style="margin-top:16px;">
    <div class="card">
      <h3>Backtest</h3>
      <form id="btForm" action="{{ url_for('dashboard.backtest') }}" method="post" enctype="multipart/form-data" onsubmit="return runBacktest(event);">
        <div class="kvs">
          <div>Symbols:</div>
          <div><input type="text" name="bt_symbols" id="bt_symbols" placeholder="Leave blank to use saved symbols"></div>

          <div>PO → Deriv:</div>
          <div><label><input type="checkbox" name="convert_po_bt" id="convert_po_bt"> Convert</label></div>

          <div>TF / Expiry:</div>
          <div class="row">
            <select name="bt_tf" id="bt_tf" style="max-width:130px">
              {% for tf in ['M1','M2','M3','M5','M10','M15','M30','H1','H4','D1'] %}
                <option value="{{ tf }}" {{ 'selected' if cfg.live_tf==tf else '' }}>{{ tf }}</option>
              {% endfor %}
            </select>
            <select name="bt_expiry" id="bt_expiry" style="max-width:130px">
              {% for e in ['1m','3m','5m','10m','30m','1h','4h'] %}
                <option value="{{ e }}" {{ 'selected' if cfg.live_expiry==e else '' }}>{{ e }}</option>
              {% endfor %}
            </select>
          </div>

          <div>Deriv fetch:</div>
          <div class="row">
            <label><input type="checkbox" name="use_deriv_fetch" {{ 'checked' if cfg.use_deriv_fetch else '' }}> Use Deriv</label>
            <input type="number" name="bt_count" min="60" step="1" value="{{ cfg.deriv_count or 300 }}" style="max-width:120px">
          </div>

          <div>Strategy:</div>
          <div>
            <select name="bt_strategy" id="bt_strategy" style="max-width:160px">
              {% for name in ['BASE','TREND','CHOP','CUSTOM1','CUSTOM2','CUSTOM3'] %}
                <option value="{{ name }}">{{ name }}</option>
              {% endfor %}
            </select>
          </div>

          <div>CSV (optional):</div>
          <div><input type="file" name="bt_csv" accept=".csv"></div>
        </div>

        <div class="row" style="margin-top:10px; gap:8px;">
          <button class="btn primary" id="btnRunBT">Run Backtest</button>
          <span id="btMsg" class="muted"></span>
        </div>
      </form>

      <div id="btResult" style="margin-top:12px; display:none;">
        <div class="row" style="justify-content: space-between;">
          <div><span class="pill" id="btSummary">—</span></div>
          <div class="muted">TF: <span id="btTF">-</span> • Exp: <span id="btExp">-</span> • Strategy: <span id="btStrat">-</span></div>
        </div>
        <div class="hr"></div>
        <img id="btPlot" class="plot" alt="Backtest plot">
      </div>
    </div>

    <!-- Live Engine -->
    <div class="card">
      <h3>Live Engine</h3>
      <div class="row" style="gap:8px; margin-bottom:8px;">
        <button class="btn success" id="btnStart">Start</button>
        <button class="btn danger" id="btnStop">Stop</button>
        <button class="btn" id="btnRefresh">Refresh</button>
        <span id="liveMsg" class="muted"></span>
      </div>
      <pre id="liveStatus">{ "loading": true }</pre>

      <div class="hr"></div>
      <h4>Telegram Broadcast</h4>
      <form id="tgForm" onsubmit="return sendTG(event);">
        <div class="kvs">
          <div>Tier:</div>
          <div>
            <select id="tgTier">
              <option value="all">All</option>
              <option value="free">Free</option>
              <option value="basic">Basic</option>
              <option value="pro">Pro</option>
              <option value="vip">VIP</option>
            </select>
          </div>
          <div>Message:</div>
          <div><textarea id="tgText" placeholder="Type a message to broadcast"></textarea></div>
        </div>
        <div class="row" style="margin-top:8px; gap:8px;">
          <button class="btn">Send</button>
          <button class="btn warn" id="btnTgTest">Send Test (All)</button>
          <span id="tgMsg" class="muted"></span>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</div>

<script>
(function(){
  // --- Pairs selector merges into symbols_text and auto-checks Convert PO→Deriv ---
  const majors = ["EURUSD","GBPUSD","USDJPY","USDCHF","USDCAD","AUDUSD","NZDUSD","EURGBP","EURJPY","GBPJPY","EURAUD","AUDJPY","CADJPY","CHFJPY"];
  const form = document.getElementById('mainForm');
  const symbolsBox = document.getElementById('symbols_text');
  const convertBox = document.getElementById('convertPO');
  const pairChecks = Array.from(document.querySelectorAll('.po-check'));

  function collectPairsIntoSymbols() {
    const selected = pairChecks.filter(c => c.checked).map(c => c.value);
    const manualRaw = (symbolsBox.value || "").replace(/[;\n\t]/g, " ");
    const manualParts = manualRaw.split(/[,\s]+/).filter(Boolean);
    // Dedup preserving order
    const merged = [];
    for (const t of [...selected, ...manualParts]) {
      if (!merged.includes(t)) merged.push(t);
    }
    symbolsBox.value = merged.join(" ");
    // If any PO majors present, auto-check Convert
    const hasPO = merged.some(s => majors.includes(s.toUpperCase()));
    if (hasPO) convertBox.checked = true;
  }

  if (form) {
    form.addEventListener('submit', (e) => { collectPairsIntoSymbols(); });
  }

  // --- Backtest AJAX ---
  async function runBacktest(ev){
    ev.preventDefault();
    const f = document.getElementById('btForm');
    const btn = document.getElementById('btnRunBT');
    const msg = document.getElementById('btMsg');
    const out = document.getElementById('btResult');
    const plot = document.getElementById('btPlot');
    const sum = document.getElementById('btSummary');
    const bttf = document.getElementById('btTF');
    const btexp = document.getElementById('btExp');
    const btstr = document.getElementById('btStrat');

    btn.disabled = true; msg.textContent = "Running…";
    try{
      // If symbols empty, we leave blank to use saved cfg; else ensure proper splitting
      const fd = new FormData(f);
      const symRaw = (fd.get('bt_symbols') || "").toString();
      const cleaned = symRaw.replace(/[;\n\t]/g, " ").split(/[,\s]+/).filter(Boolean).join(',');
      fd.set('bt_symbols', cleaned);

      const res = await fetch(f.action, { method: 'POST', body: fd });
      const js = await res.json();
      if(!res.ok || !js.ok){
        throw new Error((js && (js.error || js.code)) || ("HTTP "+res.status));
      }
      msg.textContent = "OK";
      sum.textContent = (js.stats ? `${js.stats.wins||0}W / ${js.stats.loss||0}L / ${js.stats.draw||0}D — WR ${(js.stats.win_rate||0).toFixed(1)}%` : "—");
      bttf.textContent = (fd.get('bt_tf') || '').toString();
      btexp.textContent = (fd.get('bt_expiry') || '').toString();
      btstr.textContent = (fd.get('bt_strategy') || '').toString();
      plot.src = js.plot;
      out.style.display = 'block';
    }catch(err){
      msg.textContent = "Error: " + (err.message || err);
      out.style.display = 'none';
    }finally{
      btn.disabled = false;
    }
    return false;
  }
  window.runBacktest = runBacktest;

  // --- Live Engine controls ---
  const liveStatus = document.getElementById('liveStatus');
  const liveMsg = document.getElementById('liveMsg');
  const btnStart = document.getElementById('btnStart');
  const btnStop = document.getElementById('btnStop');
  const btnRefresh = document.getElementById('btnRefresh');

  async function refreshStatus(){
    try{
      const res = await fetch('/api/status');
      const js = await res.json();
      liveStatus.textContent = JSON.stringify(js, null, 2);
    }catch(e){
      liveStatus.textContent = JSON.stringify({ ok:false, error: (e && e.message) || e }, null, 2);
    }
  }
  async function postJSON(url){
    const res = await fetch(url, { method: 'POST' });
    return res.json();
  }
  if(btnStart){ btnStart.onclick = async ()=>{ liveMsg.textContent = 'Starting…'; const js = await postJSON('/api/start'); liveMsg.textContent = js.ok ? 'Running' : ('Error: '+(js.msg||'')); refreshStatus(); };}
  if(btnStop){ btnStop.onclick  = async ()=>{ liveMsg.textContent = 'Stopping…'; const js = await postJSON('/api/stop');  liveMsg.textContent = js.ok ? 'Stopped'  : ('Error: '+(js.msg||'')); refreshStatus(); };}
  if(btnRefresh){ btnRefresh.onclick = refreshStatus; }
  refreshStatus();

  // --- Telegram ---
  async function sendTG(ev){
    ev.preventDefault();
    const tier = document.getElementById('tgTier').value;
    const text = document.getElementById('tgText').value.trim();
    const msg = document.getElementById('tgMsg');
    if(!text){ msg.textContent = "Enter text"; return false; }
    try{
      const fd = new URLSearchParams();
      fd.set('tier', tier); fd.set('text', text);
      const res = await fetch('/telegram/send', { method: 'POST', headers: { 'Content-Type':'application/x-www-form-urlencoded' }, body: fd.toString() });
      const js = await res.json();
      msg.textContent = js.ok ? 'Sent.' : ('Error: '+(js.error||''));
    }catch(e){ msg.textContent = 'Error: '+(e.message||e); }
    return false;
  }
  window.sendTG = sendTG;
  const btnTgTest = document.getElementById('btnTgTest');
  if(btnTgTest){
    btnTgTest.onclick = async (ev)=>{
      ev.preventDefault();
      const msg = document.getElementById('tgMsg');
      try{
        const fd = new URLSearchParams(); fd.set('text','🧪 Test broadcast');
        const res = await fetch('/telegram/test', { method: 'POST', headers: { 'Content-Type':'application/x-www-form-urlencoded' }, body: fd.toString() });
        const js = await res.json();
        msg.textContent = js.ok ? 'Test sent.' : 'Error sending test';
      }catch(e){ msg.textContent = 'Error: ' + (e.message||e); }
      return false;
    };
  }
})();
</script>
</body>
</html>
