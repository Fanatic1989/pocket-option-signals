<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>PO Signals — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <!-- Tailwind (CDN build is fine for dashboard) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b0f17; color:#e5e7eb; }
    .card { background:#0f172a; border:1px solid #1e293b; border-radius:14px; }
    .card h3 { color:#cbd5e1; }
    .btn { @apply px-3 py-2 rounded-lg border border-slate-600; }
    .btn-primary { background:#22c55e; border-color:#16a34a; color:#04130a; font-weight:700; }
    .btn-ghost { background:#0b0f17; }
    .badge { @apply text-xs px-2 py-0.5 rounded bg-slate-800 border border-slate-700; }
    input[type="text"], input[type="number"], select, textarea {
      background:#0b1220; border:1px solid #1f2a40; border-radius:10px; padding:.5rem .6rem; width:100%;
      color:#e5e7eb; outline:none;
    }
    input[type="checkbox"] { width:1rem; height:1rem; }
    .grid-pairs label { background:#0b1220; border:1px solid #1f2a40; border-radius:10px; padding:.35rem .55rem; }
    .kpi { background:#0b1220; border:1px solid #1f2a40; border-radius:12px; padding:.6rem .7rem; }
    .pill { background:#0b1220; border:1px solid #1f2a40; border-radius:999px; padding:.2rem .6rem; }
    .hint { color:#94a3b8; font-size:.8rem; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .legend-dot { width:.6rem; height:.6rem; border-radius:50%; display:inline-block; margin-right:.35rem; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Top bar -->
  <header class="w-full border-b border-slate-800">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="font-extrabold text-lg tracking-wide">PO Signals</div>
        <span class="pill text-xs">{{ now_local }}</span>
        <span class="pill text-xs">TZ: {{ TZ.zone if TZ else tz }}</span>
        <span class="pill text-xs">{{ "Window OK" if window_ok else "Outside Window" }}</span>
      </div>
      <div class="flex items-center gap-2">
        <a href="/" class="btn btn-ghost">Home</a>
        <a href="/dashboard" class="btn btn-ghost">Dashboard</a>
      </div>
    </div>
  </header>

  <!-- Flash messages (Flask) -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="max-w-7xl mx-auto px-4 mt-4 space-y-2">
        {% for category, message in messages %}
          <div class="rounded-lg px-3 py-2 border
                      {% if category in ['ok','success'] %}border-emerald-600 bg-emerald-900/20 text-emerald-300
                      {% elif category == 'error' %}border-rose-600 bg-rose-900/20 text-rose-300
                      {% else %}border-slate-700 bg-slate-800/40 text-slate-300{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
      <!-- LEFT COLUMN -->
      <section class="lg:col-span-2 space-y-5">

        <!-- Save Config Form -->
        <form method="POST" action="{{ url_for('dashboard.view') }}" enctype="multipart/form-data" class="space-y-5">
          <!-- Window / Time / Engine -->
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Window & Defaults</h3>
              <span class="hint">Mon–Fri enforced in backend</span>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-3">
              <div>
                <label class="text-xs text-slate-400">Start (local)</label>
                <input type="text" name="window_start" value="{{ (cfg.get('window_start') or '08:00') }}" placeholder="08:00">
              </div>
              <div>
                <label class="text-xs text-slate-400">End (local)</label>
                <input type="text" name="window_end" value="{{ (cfg.get('window_end') or '17:00') }}" placeholder="17:00">
              </div>
              <div>
                <label class="text-xs text-slate-400">Deriv fetch (count)</label>
                <input type="number" min="100" step="10" name="deriv_count" value="{{ cfg.get('deriv_count',300) }}">
                <label class="inline-flex items-center gap-2 text-sm mt-1">
                  <input type="checkbox" name="use_deriv_fetch" {% if cfg.get('use_deriv_fetch') %}checked{% endif %}>
                  Enable Deriv server fetch (fallback is CSV)
                </label>
              </div>
              <div class="flex items-end">
                <button class="btn btn-primary w-full" type="submit">Save Window & Defaults</button>
              </div>
            </div>
          </div>

          <!-- Pairs Selector + Manual -->
          <div class="card p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-semibold">Pairs</h3>
              <span class="hint">Tick majors or type any additional symbols</span>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 grid-pairs">
              {% set majors = ["EURUSD","GBPUSD","USDJPY","USDCHF","USDCAD","AUDUSD","NZDUSD","EURGBP","EURJPY","GBPJPY","EURAUD","AUDJPY","CADJPY","CHFJPY"] %}
              {% set existing = (cfg.get('symbols_raw') or []) %}
              {% for po in majors %}
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" name="pair_{{ po }}" value="{{ po }}"
                       {% if po in existing or ('frx' + po) in existing %}checked{% endif %}>
                {{ po }}
              </label>
              {% endfor %}
            </div>

            <div class="mt-3">
              <label class="block text-xs text-slate-400">Manual symbols (space or comma separated)</label>
              <textarea name="symbols_text" rows="2">{{ " ".join(existing) }}</textarea>
            </div>

            <div class="mt-2">
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" name="convert_po" >
                Convert PocketOption majors → Deriv (EURUSD → frxEURUSD)
              </label>
              <div class="hint mt-1">Saved to <span class="mono">cfg.symbols_raw</span>. Backtest can also request PO→Deriv conversion on the fly.</div>
            </div>

            <div class="mt-3">
              <button class="btn btn-primary" type="submit">Save Pairs</button>
            </div>
          </div>

          <!-- Strategies -->
          <div class="card p-4">
            <h3 class="font-semibold mb-3">Strategies (enable/disable)</h3>
            <div class="grid grid-cols-2 md:grid-cols-6 gap-2">
              {% for name in ["BASE","TREND","CHOP","CUSTOM1","CUSTOM2","CUSTOM3"] %}
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" name="strategy_{{ name }}" {% if cfg.get(name) %}checked{% endif %}>
                {{ name }}
              </label>
              {% endfor %}
            </div>
          </div>

          <!-- Custom Rules (text boxes) -->
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Custom Rules</h3>
              <span class="hint">These are free text notes for your CUSTOM1–3 strategies</span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
              <div>
                <label class="text-xs text-slate-400">CUSTOM 1</label>
                <textarea name="custom1_rules" rows="6" placeholder="Write your rules for CUSTOM1">{{ cfg.get("custom1_rules","") }}</textarea>
              </div>
              <div>
                <label class="text-xs text-slate-400">CUSTOM 2</label>
                <textarea name="custom2_rules" rows="6" placeholder="Write your rules for CUSTOM2">{{ cfg.get("custom2_rules","") }}</textarea>
              </div>
              <div>
                <label class="text-xs text-slate-400">CUSTOM 3</label>
                <textarea name="custom3_rules" rows="6" placeholder="Write your rules for CUSTOM3">{{ cfg.get("custom3_rules","") }}</textarea>
              </div>
            </div>
            <div class="mt-3">
              <button class="btn btn-primary" type="submit">Save Custom Rules</button>
            </div>
          </div>

          <!-- Indicators -->
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <h3 class="font-semibold">Indicators</h3>
              <span class="hint">Toggles & parameters map 1-for-1 to <span class="mono">INDICATOR_SPECS</span></span>
            </div>

            <!-- Render indicator cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
              {% for key, spec in ind_specs.items() %}
                {% set saved = (cfg.get('indicators',{}).get(key) or {}) %}
                <div class="p-3 rounded-lg border border-slate-700 bg-slate-900/30">
                  <div class="flex items-center justify-between">
                    <div class="font-semibold">{{ spec.title }}</div>
                    <label class="inline-flex items-center gap-2 text-sm">
                      <input type="checkbox" name="ind_{{ key }}" {% if saved.get('enabled') %}checked{% endif %}>
                      Enable
                    </label>
                  </div>
                  {% if spec.fields %}
                  <div class="grid grid-cols-2 gap-2 mt-3">
                    {% for fname, default in spec.fields.items() %}
                    <div>
                      <label class="text-xs text-slate-400">{{ fname }}</label>
                      <input type="text" name="ind_{{ key }}_{{ fname }}" value="{{ saved.get(fname, default) }}">
                    </div>
                    {% endfor %}
                  </div>
                  {% endif %}
                  <div class="mt-2 text-xs text-slate-500">Panel: {{ spec.panel }}</div>
                </div>
              {% endfor %}
            </div>

            <div class="mt-3">
              <button class="btn btn-primary" type="submit">Save Indicators</button>
            </div>
          </div>
        </form>

        <!-- Telegram Broadcaster -->
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Telegram — Broadcast / Test</h3>
            <span class="hint">Tiers: free / basic / pro / vip</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-6 gap-3 mt-3">
            <div class="md:col-span-5">
              <input type="text" id="tg_text" placeholder="Enter a message to broadcast…">
            </div>
            <div>
              <select id="tg_tier">
                <option value="all">All tiers</option>
                <option value="free">free</option>
                <option value="basic">basic</option>
                <option value="pro">pro</option>
                <option value="vip">vip</option>
              </select>
            </div>
          </div>
          <div class="flex items-center gap-3 mt-3">
            <button class="btn btn-primary" id="btnSendTG">Send</button>
            <button class="btn" id="btnTestAll">Send Test to All</button>
            <span id="tg_result" class="hint"></span>
          </div>
        </div>

      </section>

      <!-- RIGHT COLUMN -->
      <aside class="space-y-5">
        <!-- Engine Status / Live Controls -->
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Live Engine</h3>
            <div class="flex gap-2">
              <button class="btn" id="btnStart">Start</button>
              <button class="btn" id="btnStop">Stop</button>
            </div>
          </div>
          <div id="engine_status" class="mt-3 text-sm mono">Loading…</div>
          <div class="mt-3 grid grid-cols-4 gap-2">
            <div class="kpi text-center">
              <div class="text-xs text-slate-400">FREE</div>
              <div id="k_free" class="font-semibold">0</div>
            </div>
            <div class="kpi text-center">
              <div class="text-xs text-slate-400">BASIC</div>
              <div id="k_basic" class="font-semibold">0</div>
            </div>
            <div class="kpi text-center">
              <div class="text-xs text-slate-400">PRO</div>
              <div id="k_pro" class="font-semibold">0</div>
            </div>
            <div class="kpi text-center">
              <div class="text-xs text-slate-400">VIP</div>
              <div id="k_vip" class="font-semibold">0</div>
            </div>
          </div>
        </div>

        <!-- Backtest -->
        <div class="card p-4">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Backtest / Screenshot</h3>
            <span class="hint">Use Deriv server or upload CSV</span>
          </div>

          <form id="btForm" class="mt-3 space-y-3">
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs text-slate-400">Timeframe</label>
                <select name="tf">
                  {% for t in ["M1","M2","M3","M5","M10","M15","M30","H1","H4","D1"] %}
                  <option value="{{ t }}" {% if t==(cfg.get('bt_tf') or 'M1') %}selected{% endif %}>{{ t }}</option>
                  {% endfor %}
                </select>
              </div>
              <div>
                <label class="text-xs text-slate-400">Expiry</label>
                <select name="expiry">
                  {% for e in ["1m","3m","5m","10m","30m","1h","4h"] %}
                  <option value="{{ e }}" {% if e==(cfg.get('bt_expiry') or '5m') %}selected{% endif %}>{{ e }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <div>
              <label class="text-xs text-slate-400">Strategy</label>
              <select name="strategy">
                {% for s in ["BASE","TREND","CHOP","CUSTOM1","CUSTOM2","CUSTOM3"] %}
                <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
              </select>
            </div>

            <div>
              <label class="block text-xs text-slate-400">Symbols for this run (space/comma separated). Empty = use saved pairs.</label>
              <input name="symbols" type="text" placeholder="e.g. frxEURUSD frxGBPUSD" value="{{ ' '.join(cfg.get('symbols_raw',[]) or []) }}">
              <label class="inline-flex items-center gap-2 text-sm mt-2">
                <input type="checkbox" name="convert_po_deriv">
                Convert PocketOption majors to Deriv for this run
              </label>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="text-xs text-slate-400">Use Deriv server fetch</label>
                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" name="use_deriv_fetch" {% if cfg.get('use_deriv_fetch') %}checked{% endif %}>
                  <span class="hint">If unchecked, upload CSV</span>
                </label>
              </div>
              <div>
                <label class="text-xs text-slate-400">Target candles (count)</label>
                <input type="number" min="120" step="10" name="target" value="{{ cfg.get('deriv_count',300) }}">
              </div>
            </div>

            <div>
              <label class="text-xs text-slate-400">CSV Upload (optional; overrides Deriv fetch)</label>
              <input type="file" name="csv" accept=".csv" class="w-full">
            </div>

            <div class="flex items-center gap-3">
              <button class="btn btn-primary" type="submit">Run Backtest</button>
              <span id="bt_msg" class="hint"></span>
            </div>
          </form>

          <div id="bt_out" class="mt-4 hidden">
            <div class="text-sm">Stats: <span id="bt_stats" class="mono"></span></div>
            <div class="mt-2">
              <img id="bt_img" src="" alt="Backtest chart" class="w-full rounded-lg border border-slate-700">
            </div>
          </div>
        </div>

      </aside>
    </div>
  </main>

  <script>
    // ---------- Live Status ----------
    async function refreshStatus() {
      try {
        const r = await fetch('/live/status');
        const js = await r.json();
        const s = js || {};
        document.getElementById('engine_status').textContent = JSON.stringify(s, null, 2);
      } catch(e) {
        document.getElementById('engine_status').textContent = 'Status error: '+e;
      }
      try {
        const r2 = await fetch('/live/tally');
        const t = await r2.json();
        document.getElementById('k_free').textContent  = (t.free ?? t?.by_tier?.free ?? 0);
        document.getElementById('k_basic').textContent = (t.basic ?? t?.by_tier?.basic ?? 0);
        document.getElementById('k_pro').textContent   = (t.pro ?? t?.by_tier?.pro ?? 0);
        document.getElementById('k_vip').textContent   = (t.vip ?? t?.by_tier?.vip ?? 0);
      } catch {}
    }
    refreshStatus();
    setInterval(refreshStatus, 5000);

    document.getElementById('btnStart').addEventListener('click', async () => {
      const r = await fetch('/live/start', {method:'POST'});
      await refreshStatus();
    });
    document.getElementById('btnStop').addEventListener('click', async () => {
      const r = await fetch('/live/stop', {method:'POST'});
      await refreshStatus();
    });

    // ---------- Telegram ----------
    document.getElementById('btnSendTG').addEventListener('click', async () => {
      const text = document.getElementById('tg_text').value.trim();
      const tier = document.getElementById('tg_tier').value;
      if (!text) { document.getElementById('tg_result').textContent='Text required'; return; }
      const fd = new FormData();
      fd.append('text', text);
      fd.append('tier', tier);
      const r = await fetch('/telegram/send', {method:'POST', body: fd});
      const js = await r.json();
      document.getElementById('tg_result').textContent = js.ok ? 'Sent' : ('Error: '+(js.error||''));
    });

    document.getElementById('btnTestAll').addEventListener('click', async () => {
      const fd = new FormData();
      fd.append('text', '🧪 Dashboard Test');
      const r = await fetch('/telegram/test', {method:'POST', body: fd});
      const js = await r.json();
      document.getElementById('tg_result').textContent = js.ok ? 'Test sent' : 'Test error';
    });

    // ---------- Backtest ----------
    const btForm = document.getElementById('btForm');
    btForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      document.getElementById('bt_msg').textContent = 'Running…';
      const fd = new FormData(btForm);
      try {
        const r = await fetch('/backtest', {method:'POST', body: fd});
        const js = await r.json();
        if (!js.ok) {
          document.getElementById('bt_msg').textContent = 'Error: '+(js.error||'');
          document.getElementById('bt_out').classList.add('hidden');
          return;
        }
        document.getElementById('bt_stats').textContent =
          (js.stats?.wins||0)+'W / '+(js.stats?.loss||0)+'L / '+(js.stats?.draw||0)+'D — WR '+(js.stats?.win_rate?.toFixed(1)||'0.0')+'%';
        document.getElementById('bt_img').src = js.plot.startsWith('/static/') ? js.plot : ('/static/plots/'+js.plot);
        document.getElementById('bt_out').classList.remove('hidden');
        document.getElementById('bt_msg').textContent = 'Done';
      } catch (err) {
        document.getElementById('bt_msg').textContent = 'Error: '+err;
        document.getElementById('bt_out').classList.add('hidden');
      }
    });
  </script>
</body>
</html>
