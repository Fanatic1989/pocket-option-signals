<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Pocket Option Signals · Live Engine</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --bg:#0b1220; --panel:#111827; --panel-2:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --green:#10b981; --red:#ef4444; --blue:#3b82f6; --card-radius:16px; }
    *{box-sizing:border-box}
    body{margin:0;padding:20px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#09101d 0%,#0b1220 60%,#0a0f1b 100%);color:var(--text)}
    h1{margin:0 0 16px;font-size:22px}
    .grid{display:grid;grid-template-columns:320px 1fr;gap:20px;align-items:start}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:var(--card-radius);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .controls button{margin:6px 8px 6px 0;padding:10px 14px;border:none;border-radius:10px;background:#1f2937;color:var(--text);cursor:pointer;font-weight:600}
    .controls .start{background:#14532d}.controls .stop{background:#7f1d1d}.controls .on{background:#1e3a8a}.controls .off{background:#334155}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
    .pill.running{background:rgba(16,185,129,.15);color:var(--green);border:1px solid rgba(16,185,129,.35)}
    .pill.stopped{background:rgba(239,68,68,.15);color:var(--red);border:1px solid rgba(239,68,68,.35)}
    .pill.debug{background:rgba(59,130,246,.15);color:var(--blue);border:1px solid rgba(59,130,246,.35)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{flex:1 1 120px;min-width:120px;background:var(--panel-2);border:1px solid #1f2937;border-radius:14px;padding:12px}
    .kpi h4{margin:0 0 6px;font-size:13px;color:var(--muted)} .kpi .num{font-size:26px;font-weight:800}
    .text-box{width:100%;min-height:80px;max-height:160px;background:#0b1324;color:var(--text);border:1px solid #1f2937;border-radius:12px;padding:10px 12px;outline:none;overflow:auto;resize:vertical;line-height:1.35;overflow-wrap:anywhere;word-break:break-word;white-space:normal}
    .tier-card{margin-top:14px}.tier-card h3{margin:0 0 8px;font-size:16px}
    .send-row{display:flex;gap:10px;margin-top:10px}
    .send-row button{padding:10px 14px;font-weight:700;border:none;border-radius:10px;background:#1d4ed8;color:#fff;cursor:pointer}
    .muted{color:var(--muted);font-size:12px}
    pre{background:#0b1324;border:1px solid #1f2937;border-radius:12px;padding:12px;overflow:auto;max-height:220px;overflow-wrap:anywhere;word-break:break-word;white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>Live Engine</h1>
  <div class="grid">
    <div class="card">
      <div class="controls">
        <button class="start" onclick="post('/api/start')">Start</button>
        <button class="stop" onclick="post('/api/stop')">Stop</button>
        <button class="on" onclick="post('/api/debug_on')">Debug ON</button>
        <button class="off" onclick="post('/api/debug_off')">Debug OFF</button>
      </div>
      <div id="badges" style="margin-top:10px"></div>
      <div class="row" style="margin-top:12px">
        <div class="kpi"><h4>Free</h4><div class="num" id="freeCount">0</div><div class="muted" id="freeCap"></div></div>
        <div class="kpi"><h4>Basic</h4><div class="num" id="basicCount">0</div><div class="muted" id="basicCap"></div></div>
        <div class="kpi"><h4>Pro</h4><div class="num" id="proCount">0</div><div class="muted" id="proCap"></div></div>
        <div class="kpi"><h4>VIP</h4><div class="num" id="vipCount">0</div><div class="muted" id="vipCap"></div></div>
        <div class="kpi"><h4>All</h4><div class="num" id="totalCount">0</div><div class="muted">day total</div></div>
      </div>
      <div style="margin-top:14px"><div class="muted">Tiers daily caps: Free=3, Basic=5, Pro=15, VIP=∞ (enforced)</div></div>
      <div style="margin-top:16px"><h3 style="margin:0 0 8px">Telegram Bot</h3><button onclick="checkBot()">Check getMe()</button><div id="botInfo" class="muted" style="margin-top:8px"></div></div>
      <div style="margin-top:16px"><h3 style="margin:0 0 8px">Last Send Result</h3><pre id="lastSend">—</pre></div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 12px">Send Messages</h3>
      <div class="tier-card">
        <h3>VIP <span class="muted">(test-send)</span></h3>
        <textarea id="vipText" class="text-box" placeholder="Type a VIP test message..."></textarea>
        <div class="send-row"><button onclick="sendVIP()">Send VIP Test</button><span id="vipCfg" class="muted"></span></div>
      </div>
      <div class="tier-card">
        <h3>Free</h3>
        <textarea id="freeText" class="text-box" placeholder="Message for Free tier (cap 3/day)"></textarea>
        <div class="send-row"><button onclick="sendTier('free','freeText')">Send Free</button><span id="freeCfg" class="muted"></span></div>
      </div>
      <div class="tier-card">
        <h3>Basic</h3>
        <textarea id="basicText" class="text-box" placeholder="Message for Basic tier (cap 5/day)"></textarea>
        <div class="send-row"><button onclick="sendTier('basic','basicText')">Send Basic</button><span id="basicCfg" class="muted"></span></div>
      </div>
      <div class="tier-card">
        <h3>Pro</h3>
        <textarea id="proText" class="text-box" placeholder="Message for Pro tier (cap 15/day)"></textarea>
        <div class="send-row"><button onclick="sendTier('pro','proText')">Send Pro</button><span id="proCfg" class="muted"></span></div>
      </div>
    </div>
  </div>

  <script>
    async function post(url="", body={}){ const r=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(body)}); return r.json(); }
    async function get(url=""){ const r=await fetch(url); return r.json(); }

    function capText(cap){ if(cap==null) return ""; if(cap===Infinity || cap==="Infinity") return "cap: ∞"; return `cap: ${cap}`; }

    function renderStatus(s){
      const badges=document.getElementById("badges");
      badges.innerHTML=`<span class="pill ${s.running?'running':'stopped'}">${s.running?'RUNNING':'STOPPED'}</span>
                        <span class="pill debug">${s.debug?'DEBUG ON':'DEBUG OFF'}</span>
                        <span class="pill">UTC Day: ${s.day}</span>`;
      document.getElementById("freeCount").textContent=s.tallies.free??0;
      document.getElementById("basicCount").textContent=s.tallies.basic??0;
      document.getElementById("proCount").textContent=s.tallies.pro??0;
      document.getElementById("vipCount").textContent=s.tallies.vip??0;
      document.getElementById("totalCount").textContent=s.tallies.all??s.tallies.total??0;
      document.getElementById("freeCap").textContent=capText(s.caps.free);
      document.getElementById("basicCap").textContent=capText(s.caps.basic);
      document.getElementById("proCap").textContent=capText(s.caps.pro);
      document.getElementById("vipCap").textContent=capText(s.caps.vip);
      document.getElementById("freeCfg").textContent=s.configured_chats.free?"chat configured":"no chat id";
      document.getElementById("basicCfg").textContent=s.configured_chats.basic?"chat configured":"no chat id";
      document.getElementById("proCfg").textContent=s.configured_chats.pro?"chat configured":"no chat id";
      document.getElementById("vipCfg").textContent=s.configured_chats.vip?"chat configured":"no chat id";
      const last=s.last_send_result&&Object.keys(s.last_send_result).length?JSON.stringify(s.last_send_result,null,2):"—";
      document.getElementById("lastSend").textContent=last;
    }
    async function refresh(){ renderStatus(await get("/api/status")); }
    async function checkBot(){ const info=await get("/api/check_bot"); document.getElementById("botInfo").textContent=JSON.stringify(info.getMe||info,null,2); }
    async function sendVIP(){ const text=document.getElementById("vipText").value.trim(); const res=await post("/api/test/vip",{text}); renderStatus(res.status); }
    async function sendTier(tier,area){ const text=document.getElementById(area).value.trim(); const res=await post("/api/send",{tier,text}); if(!res.result?.ok&&res.result?.error){alert(res.result.error)} renderStatus(res.status||await get("/api/status")); }
    refresh(); setInterval(refresh,4000);
  </script>
</body>
</html>
