<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Signals Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="h-full bg-slate-900 text-slate-100">
  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="max-w-6xl mx-auto mt-4 space-y-2">
      {% for cat,msg in messages %}
        <div class="px-4 py-2 rounded border
                    {% if cat in ['ok','success'] %}border-emerald-500 bg-emerald-900/30
                    {% elif cat=='error' %}border-rose-500 bg-rose-900/30
                    {% else %}border-slate-600 bg-slate-800{% endif %}">
          {{ msg }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
  {% endwith %}

  {% if view == 'login' %}
    <div class="min-h-full flex items-center justify-center py-24">
      <form action="{{ url_for('dashboard.login') }}" method="post" class="w-full max-w-sm bg-slate-800/60 p-6 rounded-xl border border-slate-700 space-y-4">
        <h1 class="text-xl font-semibold">Sign in</h1>
        <label class="block text-sm">Admin password</label>
        <input name="password" type="password" class="w-full px-3 py-2 rounded bg-slate-900 border border-slate-700" />
        <button class="w-full mt-3 px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">Login</button>
      </form>
    </div>
  {% else %}
  <!-- Top bar -->
  <header class="border-b border-slate-800">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-lg font-semibold">Signals Dashboard</div>
        <div class="text-slate-400 text-sm">TZ: {{ tz }} • {{ now }}</div>
        <div class="ml-3 text-xs px-2 py-1 rounded
          {% if window_ok %}bg-emerald-800/40 border border-emerald-700 text-emerald-200{% else %}bg-amber-800/40 border border-amber-700 text-amber-200{% endif %}">
          Trading window {% if window_ok %}OPEN{% else %}CLOSED{% endif %} (Mon–Fri, {{ cfg.window.start }}–{{ cfg.window.end }})
        </div>
      </div>
      <div class="flex items-center gap-3">
        <a class="text-sm text-slate-300 underline" href="{{ url_for('dashboard.logout') }}">Logout</a>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Column 1 -->
    <section class="space-y-6 lg:col-span-2">

      <!-- Window + defaults -->
      <form action="{{ url_for('dashboard.view') }}" method="post" class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Window & Defaults</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div>
            <label class="block text-xs text-slate-400">Window start</label>
            <input name="window_start" value="{{ cfg.window.start }}" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700"/>
          </div>
          <div>
            <label class="block text-xs text-slate-400">Window end</label>
            <input name="window_end" value="{{ cfg.window.end }}" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700"/>
          </div>
          <div>
            <label class="block text-xs text-slate-400">Timezone</label>
            <input name="window_tz" value="{{ cfg.window.timezone }}" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700"/>
          </div>
          <div>
            <label class="block text-xs text-slate-400">Live TF</label>
            <select name="live_tf" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
              {% for tf in ['M1','M2','M3','M5','M10','M15','M30','H1','H4','D1'] %}
                <option value="{{ tf }}" {% if cfg.live_tf==tf %}selected{% endif %}>{{ tf }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-400">Live Expiry</label>
            <select name="live_expiry" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
              {% for ex in ['1m','3m','5m','10m','30m','1h','4h'] %}
                <option value="{{ ex }}" {% if cfg.live_expiry==ex %}selected{% endif %}>{{ ex }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label class="block text-xs text-slate-400">Deriv bars (count)</label>
            <input name="deriv_count" value="{{ cfg.deriv_count }}" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700"/>
          </div>
          <div class="flex items-end gap-2">
            <input id="use_deriv_fetch" type="checkbox" name="use_deriv_fetch" {% if cfg.use_deriv_fetch %}checked{% endif %} class="h-4 w-4">
            <label for="use_deriv_fetch" class="text-sm">Use Deriv server fetch</label>
          </div>
        </div>

        <!-- Symbols -->
        <div class="mt-3">
          <label class="block text-xs text-slate-400">Symbols (space/comma separated)</label>
          <textarea name="symbols_text" rows="2" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700">{{ " ".join(cfg.symbols_raw or []) }}</textarea>
          <div class="mt-2 flex items-center gap-3">
            <label class="inline-flex items-center gap-2 text-sm">
              <input type="checkbox" name="convert_po" class="h-4 w-4"> Convert PocketOption majors to Deriv (e.g., EURUSD → frxEURUSD)
            </label>
          </div>
        </div>

        <!-- Strategies -->
        <div class="mt-4 grid grid-cols-2 md:grid-cols-6 gap-2">
          {% for name in ["BASE","TREND","CHOP","CUSTOM1","CUSTOM2","CUSTOM3"] %}
          <label class="inline-flex items-center gap-2 text-sm">
            <input type="checkbox" name="s_{{ name }}" class="h-4 w-4"
              {% if (cfg.strategies.get(name) or {}).get('enabled') %}checked{% endif %}>
            {{ name }}
          </label>
          {% endfor %}
        </div>

        <div class="pt-3">
          <button class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">Save</button>
        </div>
      </form>

      <!-- Indicators -->
      <form action="{{ url_for('dashboard.update_indicators') }}" method="post" class="bg-slate-800/50 border border-slate-700 rounded-xl p-4">
        <h2 class="text-lg font-semibold mb-3">Indicators</h2>
        <div class="grid md:grid-cols-2 gap-4">
          {% for key,spec in ind_specs.items() %}
          {% set cfg_ind = (cfg.indicators.get(key) or {}) %}
          <div class="p-3 rounded-lg border border-slate-700 bg-slate-900/40">
            <div class="flex items-center justify-between">
              <div class="font-medium">{{ spec.title }}</div>
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="checkbox" name="ind_{{ key }}" class="h-4 w-4" {% if cfg_ind.get('enabled') %}checked{% endif %}>
                Enable
              </label>
            </div>
            {% if spec.fields %}
            <div class="mt-2 grid grid-cols-2 gap-2">
              {% for fname,default in spec.fields.items() %}
              <div>
                <label class="block text-[11px] text-slate-400">{{ fname }}</label>
                <input name="ind_{{ key }}_{{ fname }}" value="{{ cfg_ind.get(fname, default) }}"
                       class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700"/>
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        <div class="pt-3">
          <button class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">Save indicators</button>
        </div>
      </form>

      <!-- Custom rule text boxes -->
      <form action="{{ url_for('dashboard.update_custom') }}" method="post" class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Custom Rules</h2>
        <div class="grid md:grid-cols-3 gap-3">
          <div>
            <label class="block text-xs text-slate-400 mb-1">CUSTOM 1 (enabled via Strategies)</label>
            <textarea name="custom1_rules" rows="6" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700">{{ cfg.custom1_rules }}</textarea>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">CUSTOM 2</label>
            <textarea name="custom2_rules" rows="6" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700">{{ cfg.custom2_rules }}</textarea>
          </div>
          <div>
            <label class="block text-xs text-slate-400 mb-1">CUSTOM 3</label>
            <textarea name="custom3_rules" rows="6" class="w-full px-2 py-2 rounded bg-slate-900 border border-slate-700">{{ cfg.custom3_rules }}</textarea>
          </div>
        </div>
        <button class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">Save custom rules</button>
      </form>

    </section>

    <!-- Column 2 -->
    <section class="space-y-6">
      <!-- Telegram -->
      <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Telegram</h2>

        <form id="tg-send" action="{{ url_for('dashboard.telegram_send') }}" method="post" class="space-y-2">
          <div class="flex items-center gap-2">
            <select name="tier" class="px-2 py-1 rounded bg-slate-900 border border-slate-700">
              <option value="all">All</option>
              <option value="free">Free</option>
              <option value="basic">Basic</option>
              <option value="pro">Pro</option>
              <option value="vip">VIP</option>
            </select>
            <input name="text" placeholder="Message to send…" class="flex-1 px-2 py-1 rounded bg-slate-900 border border-slate-700"/>
            <button class="px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500">Send</button>
          </div>
        </form>

        <form id="tg-test" action="{{ url_for('dashboard.telegram_test') }}" method="post">
          <button class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500">Test VIP/Broadcast</button>
        </form>

        <button id="btn-diag" class="px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600">Bot diag</button>
        <pre id="tg-diag" class="text-xs bg-slate-900 border border-slate-700 rounded p-2 overflow-x-auto"></pre>

        <div class="text-xs text-slate-400">
          Configured chats: {{ tier_to_chat }}
        </div>
      </div>

      <!-- Live engine -->
      <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Live Engine</h2>
        <div class="flex flex-wrap items-center gap-2">
          <button id="live-start" class="px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500">Start</button>
          <button id="live-stop" class="px-3 py-1.5 rounded bg-rose-600 hover:bg-rose-500">Stop</button>
          <button id="dbg-on" class="px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600">Debug on</button>
          <button id="dbg-off" class="px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600">Debug off</button>
          <button id="refresh-status" class="px-3 py-1.5 rounded bg-slate-700 hover:bg-slate-600">Refresh</button>
        </div>
        <pre id="live-status" class="text-xs bg-slate-900 border border-slate-700 rounded p-2 overflow-x-auto">{{ engine | tojson(indent=2) }}</pre>
        <div>
          <div class="text-sm font-medium mb-1">Tally</div>
          <pre id="live-tally" class="text-xs bg-slate-900 border border-slate-700 rounded p-2 overflow-x-auto"></pre>
        </div>
      </div>

      <!-- Backtest -->
      <div class="bg-slate-800/50 border border-slate-700 rounded-xl p-4 space-y-3">
        <h2 class="text-lg font-semibold">Backtest</h2>
        <form id="bt-form" action="{{ url_for('dashboard.backtest') }}" method="post" enctype="multipart/form-data" class="space-y-2">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs text-slate-400">Symbols</label>
              <input name="bt_symbols" placeholder="frxEURUSD frxGBPUSD ..." class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700"/>
              <label class="inline-flex items-center gap-2 text-xs mt-1">
                <input type="checkbox" name="convert_po_bt" class="h-4 w-4"> Convert PO→Deriv
              </label>
            </div>
            <div>
              <label class="block text-xs text-slate-400">CSV (optional; overrides network)</label>
              <input type="file" name="bt_csv" class="w-full text-xs"/>
            </div>
            <div>
              <label class="block text-xs text-slate-400">TF</label>
              <select name="bt_tf" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                {% for tf in ['M1','M2','M3','M5','M10','M15','M30','H1','H4','D1'] %}
                  <option value="{{ tf }}" {% if cfg.live_tf==tf %}selected{% endif %}>{{ tf }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-400">Expiry</label>
              <select name="bt_expiry" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                {% for ex in ['1m','3m','5m','10m','30m','1h','4h'] %}
                  <option value="{{ ex }}" {% if cfg.live_expiry==ex %}selected{% endif %}>{{ ex }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-400">Strategy</label>
              <select name="bt_strategy" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700">
                {% for s in ['BASE','TREND','CHOP','CUSTOM1','CUSTOM2','CUSTOM3'] %}
                  <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
              </select>
            </div>
            <div>
              <label class="block text-xs text-slate-400">Bars (Deriv count)</label>
              <input name="bt_count" value="{{ cfg.deriv_count }}" class="w-full px-2 py-1 rounded bg-slate-900 border border-slate-700"/>
            </div>
          </div>
          <label class="inline-flex items-center gap-2 text-sm">
            <input type="checkbox" name="use_deriv_fetch" {% if cfg.use_deriv_fetch %}checked{% endif %} class="h-4 w-4"> Use Deriv server fetch
          </label>
          <div class="pt-1">
            <button class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500">Run backtest</button>
          </div>
        </form>

        <div id="bt-out" class="space-y-2">
          {% if session.get('bt_state') %}
            <div class="text-sm">{{ session['bt_state']['summary'] }}</div>
            {% if session['bt_state'].get('plot_name') %}
              <img src="{{ url_for('dashboard.plot_file', name=session['bt_state']['plot_name']) }}" class="w-full rounded border border-slate-700"/>
            {% endif %}
          {% endif %}
        </div>
        <div class="flex items-center gap-3 text-sm">
          <a class="underline text-slate-300" href="{{ url_for('dashboard.backtest_last_json') }}">last.json</a>
          <!-- CSV of signals (if you wire rows later) -->
        </div>
      </div>
    </section>

  </main>

  {% endif %}

  <script>
  // ---- Telegram diag
  document.getElementById('btn-diag')?.addEventListener('click', async () => {
    const r = await fetch('{{ url_for("dashboard.api_check_bot") }}');
    const j = await r.json();
    document.getElementById('tg-diag').textContent = JSON.stringify(j, null, 2);
  });

  // ---- Live controls
  async function postJSON(url){ const r = await fetch(url,{method:'POST'}); return r.json(); }
  async function refreshStatus(){
    const s = await fetch('{{ url_for("dashboard.live_status") }}'); 
    const j = await s.json();
    document.getElementById('live-status').textContent = JSON.stringify(j, null, 2);
    const t = await fetch('{{ url_for("dashboard.live_tally") }}');
    const tj = await t.json();
    document.getElementById('live-tally').textContent = JSON.stringify(tj, null, 2);
  }
  document.getElementById('live-start')?.addEventListener('click', async()=>{await postJSON('{{ url_for("dashboard.live_start") }}'); refreshStatus();});
  document.getElementById('live-stop')?.addEventListener('click', async()=>{await postJSON('{{ url_for("dashboard.live_stop") }}'); refreshStatus();});
  document.getElementById('dbg-on')?.addEventListener('click', async()=>{await postJSON('{{ url_for("dashboard.live_debug_on") }}');});
  document.getElementById('dbg-off')?.addEventListener('click', async()=>{await postJSON('{{ url_for("dashboard.live_debug_off") }}');});
  document.getElementById('refresh-status')?.addEventListener('click', refreshStatus);
  refreshStatus();

  // ---- AJAX backtest (keep page snappy)
  document.getElementById('bt-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const fd = new FormData(form);
    const out = document.getElementById('bt-out');
    out.innerHTML = '<div class="text-sm text-slate-300">Running…</div>';
    try {
      const r = await fetch(form.action, { method:'POST', body: fd });
      const j = await r.json();
      if(!j.ok){
        out.innerHTML = `<div class="text-sm text-rose-300">Error: ${j.error || 'unknown'}</div>`;
        return;
      }
      out.innerHTML = `
        <div class="text-sm">${(j.stats.wins||0)}W / ${(j.stats.loss||0)}L / ${(j.stats.draw||0)}D — WR ${Number(j.stats.win_rate||0).toFixed(1)}%</div>
        <img src="${j.plot}" class="w-full rounded border border-slate-700"/>
      `;
    } catch(err){
      out.innerHTML = `<div class="text-sm text-rose-300">Error: ${err}</div>`;
    }
  });
  </script>
</body>
</html>
