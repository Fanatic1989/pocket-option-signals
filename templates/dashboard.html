{% set app_name = "Pocket Option Signals" %}
<!doctype html><html><head><meta charset="utf-8"><title>{{ app_name }}</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
:root { --bg:#0b1220; --panel:#0f172a; --text:#e5f0ff; --cyan:#38bdf8; --red:#ef4444; --green:#10b981; }
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;background:linear-gradient(90deg,#0f172a,#0b1220)}
a.btn,button.btn{background:var(--cyan);color:#00111f;border:none;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:600;cursor:pointer}
.link{background:transparent;color:var(--cyan);padding:0;border:none}
main{max-width:1160px;margin:24px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
.card{grid-column:span 12;background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:14px;padding:16px}
@media(min-width:950px){.span6{grid-column:span 6}.span4{grid-column:span 4}.span8{grid-column:span 8}}
label{display:block;margin:8px 0 4px;color:#bcdcff}
input[type="text"],input[type="password"],input[type="number"],select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #24324a;background:#0b1220;color:#e5f0ff}
section.ind{border:1px solid #22304a;border-radius:12px;padding:12px;margin:10px 0}
table{width:100%;border-collapse:collapse;font-size:14px} th,td{border-bottom:1px solid #1d2740;padding:8px;text-align:left}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px}.ok{background:#063}.bad{background:#450a0a}.muted{color:#9eb3d9}
.flash{padding:10px 14px;border-radius:10px;background:#13253d;margin-bottom:12px}
.code{font-family:ui-monospace,monospace;background:#0a1120;padding:4px 6px;border-radius:8px}
select.multiselect{min-height:160px}
.grid-cols{display:grid;grid-template-columns:repeat(4, minmax(0,1fr));gap:8px}
@media(max-width:900px){.grid-cols{grid-template-columns:repeat(2, minmax(0,1fr));}}
</style></head><body>
<header><div><strong>{{ app_name }}</strong></div>
<nav>
{% if session.get('admin') %}
  <a class="btn" href="{{ url_for('dashboard.dashboard') }}">Dashboard</a>
  <a class="btn" href="{{ url_for('dashboard.logout') }}">Logout</a>
{% else %}
  <a class="btn" href="{{ url_for('dashboard.login') }}">Admin Login</a>
{% endif %}
</nav></header>
<main>
{% with messages = get_flashed_messages() %}{% if messages %}{% for m in messages %}<div class="flash">{{ m }}</div>{% endfor %}{% endif %}{% endwith %}

{% if view == "login" %}
  <div class="card span6">
    <h2>Admin Login</h2>
    <form method="post">
      <label>Password</label><input type="password" name="password" required/>
      <div style="margin-top:12px"><button class="btn" type="submit">Login</button></div>
    </form>
  </div>

{% elif view == "index" %}
  <div class="grid">
    <div class="card span8">
      <h2>Welcome</h2>
      <p>Binary options dashboard with indicator toggles, Deriv pull, backtester, and <b>Simple English</b> custom strategy.</p>
      <p class="muted">Live mode reads: <span class="code">/data/latest.csv</span> (timestamp,open,high,low,close).</p>
    </div>
    <div class="card span4">
      <h3>Status</h3>
      <div>Now: {{ now }}</div>
      <div class="muted">TZ: {{ tz }}</div>
    </div>
  </div>

{% else %} {# dashboard #}
<div class="grid">

  <div class="card span6">
    <h2>Trading Window</h2>
    <form method="post" action="{{ url_for('dashboard.update_window') }}">
      <label>Start (HH:MM)</label><input type="text" name="start" value="{{ window.start }}"/>
      <label>End (HH:MM)</label><input type="text" name="end" value="{{ window.end }}"/>
      <label>Timezone</label><input type="text" name="timezone" value="{{ window.timezone }}"/>
      <div style="margin-top:10px"><button class="btn">Save</button></div>
    </form>
  </div>

  <div class="card span6">
    <h2>Strategies</h2>
    <form method="post" action="{{ url_for('dashboard.update_strategies') }}">
      {% for name, opts in strategies.items() %}
      <label><input type="checkbox" name="s_{{name}}" {% if opts.enabled %}checked{% endif %}/> {{ name }}</label>
      {% endfor %}
      <div style="margin-top:10px"><button class="btn">Save</button></div>
    </form>
  </div>

  <div class="card span12">
    <h2>Indicators</h2>
    <form method="post" action="{{ url_for('dashboard.update_indicators') }}">
      <div class="grid-cols">
        {% for key, spec in specs.items() %}
        <section class="ind">
          <h3 style="margin:0 0 8px 0">{{ spec.name }}</h3>
          <label><input type="checkbox" name="{{ key }}_enabled" {% if indicators[key] and indicators[key].enabled %}checked{% endif %}/> Enabled</label>
          {% for pkey, default in spec.params.items() %}
            <label>{{ pkey|upper }}</label>
            <input type="number" step="any" name="{{ key }}_{{ pkey }}" value="{{ indicators[key][pkey] if indicators[key] is defined and indicators[key][pkey] is defined else default }}"/>
          {% endfor %}
        </section>
        {% endfor %}
      </div>
      <div style="margin-top:10px"><button class="btn">Save</button></div>
    </form>
  </div>

  <div class="card span12">
    <h2>Custom Rules (Strategy: CUSTOM)</h2>
    <form method="post" action="{{ url_for('dashboard.update_custom') }}">
      <label><input type="checkbox" name="custom_enabled" {% if custom.enabled %}checked{% endif %}/> Enable Custom Rules</label>

      <label>Rule Type</label>
      <select name="mode">
        <option value="SIMPLE" {% if custom.mode == 'SIMPLE' %}selected{% endif %}>Simple sentence</option>
        <option value="EXPERT" {% if custom.mode == 'EXPERT' %}selected{% endif %}>Expert (DSL)</option>
      </select>

      <div id="simple-box">
        <label>Simple BUY Rule (English)</label>
        <textarea name="simple_buy" rows="2">{{ custom.simple_buy }}</textarea>
        <label>Simple SELL Rule (English)</label>
        <textarea name="simple_sell" rows="2">{{ custom.simple_sell }}</textarea>
      </div>

      <div id="expert-box">
        <label>BUY Rule (DSL)</label>
        <textarea name="buy_rule" rows="3">{{ custom.buy_rule }}</textarea>
        <label>SELL Rule (DSL)</label>
        <textarea name="sell_rule" rows="3">{{ custom.sell_rule }}</textarea>
      </div>

      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px">
        <div><label>Tolerance %</label><input type="number" step="any" name="tol_pct" value="{{ custom.tol_pct or 0.1 }}"/></div>
        <div><label>Lookback</label><input type="number" step="1" name="lookback" value="{{ custom.lookback or 3 }}"/></div>
      </div>

      <div style="margin-top:10px"><button class="btn">Save Custom Rules</button></div>
    </form>
    <script>
      (function(){
        function sync(){
          var mode = document.querySelector('select[name="mode"]').value;
          document.getElementById('simple-box').style.display = (mode === 'SIMPLE') ? '' : 'none';
          document.getElementById('expert-box').style.display = (mode === 'EXPERT') ? '' : 'none';
        }
        document.querySelector('select[name="mode"]').addEventListener('change', sync);
        sync();
      })();
    </script>
  </div>

  <div class="card span12">
    <h2>Backtest Simulator (Binary)</h2>
    <form method="post" action="{{ url_for('dashboard.backtest') }}" enctype="multipart/form-data">
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <div style="flex:2"><label>CSV File</label><input type="file" name="file" accept=".csv"/></div>
        <div style="flex:1"><label>Strategy</label>
          <select name="strategy"><option>BASE</option><option>TREND</option><option>CHOP</option><option>CUSTOM</option></select>
        </div>
        <div style="flex:1">
          <label>Candle TF</label>
          <select name="tf"><option>M1</option><option>M2</option><option>M3</option><option>M5</option><option>M10</option><option>M15</option><option>M30</option><option>H1</option><option>H4</option><option>D1</option></select>
        </div>
        <div style="flex:1">
          <label>Expiry</label>
          <select name="expiry"><option>1m</option><option>3m</option><option>5m</option><option>30m</option><option>H1</option><option>H4</option></select>
        </div>
      </div>

      <fieldset style="margin-top:10px;border:1px solid #22304a;padding:8px;border-radius:10px">
        <legend style="color:#9eb3d9">Pull last month from Deriv</legend>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="flex:1"><label>App ID</label><input type="text" name="app_id" placeholder="1089 (test)" /></div>
          <div style="flex:1"><label>Symbol</label><input type="text" name="symbol" placeholder="R_100" /></div>
          <div style="flex:1"><label>Granularity</label>
            <select name="granularity">
              <option value="60">M1</option><option value="120">M2</option><option value="180">M3</option>
              <option value="300" selected>M5</option><option value="600">M10</option><option value="900">M15</option>
              <option value="1800">M30</option><option value="3600">H1</option><option value="14400">H4</option>
              <option value="86400">D1</option>
            </select>
          </div>
          <div style="flex:1"><label>Candles</label><input type="number" name="count" value="1440"/></div>
        </div>
        <div style="margin-top:8px">
          <button class="btn" formaction="{{ url_for('dashboard.deriv_fetch') }}" formmethod="post" formnovalidate>Pull from Deriv</button>
        </div>
        <small class="muted">Saves to <span class="code">/tmp/deriv_last_month.csv</span>.</small>
      </fieldset>

      <label style="margin-top:10px"><input type="checkbox" name="use_server" value="1"/> Use server data: <span class="code">/tmp/deriv_last_month.csv</span></label>

      <fieldset style="margin-top:10px;border:1px solid #22304a;padding:8px;border-radius:10px">
        <legend style="color:#9eb3d9">Date Filter</legend>
        <div style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-end">
          <div><label>Month</label><input type="month" name="month" /><small class="muted">YYYY-MM</small></div>
          <div>
            <label>Weekdays</label>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              {% for d in ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'] %}
                <label><input type="checkbox" name="wd" value="{{ d }}" {% if d in ['Mon','Tue','Wed','Thu','Fri'] %}checked{% endif %}/> {{ d }}</label>
              {% endfor %}
            </div>
          </div>
          <div>
            <label>Last N Days</label>
            <select name="last_n">
              <option value="">—</option>
              <option>7</option><option>14</option><option selected>30</option><option>60</option><option>90</option>
            </select>
            <small class="muted">If set, overrides Month filter.</small>
          </div>
        </div>
      </fieldset>

      <div style="margin-top:10px"><button class="btn">Run Backtest</button></div>
    </form>

    {% if bt %}
      <h3>Results</h3>
      <p>Trades: <b>{{ bt.trades }}</b> • Wins: <b style="color:var(--green)">{{ bt.wins }}</b> •
      Losses: <b style="color:var(--red)">{{ bt.losses }}</b> • Draws: <b>{{ bt.draws }}</b> •
      Win Rate: <b>{{ "%.2f"|format(bt.winrate*100) }}%</b></p>
      <details><summary>Sample Signals (last 20)</summary>
        <table><thead><tr><th>Idx</th><th>Entry Time</th><th>Signal</th><th>Entry</th><th>Expiry Time</th><th>Exit</th><th>Outcome</th></tr></thead>
        <tbody>{% for r in bt.rows %}<tr>
          <td>{{ r.idx }}</td><td>{{ r.time_in }}</td><td>{{ r.dir }}</td><td>{{ "%.5f"|format(r.entry) }}</td>
          <td>{{ r.time_out }}</td><td>{{ "%.5f"|format(r.exit) }}</td><td>{{ r.outcome }}</td>
        </tr>{% endfor %}</tbody></table>
      </details>
    {% endif %}
  </div>

</div>
{% endif %}
</main></body></html>
