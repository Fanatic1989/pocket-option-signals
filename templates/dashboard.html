<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Pocket Option Signals â€” Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#0b0f14; --card:#121821; --muted:#8aa0b2; --text:#eaf2f9; --acc:#56b6f7; --acc2:#7ee787; --danger:#ff5c7c; }
    * { box-sizing: border-box }
    body { margin:0; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--text); }
    a { color:var(--acc) }
    h1,h2,h3 { margin:0 0 .6rem }
    h2 { font-size:1.1rem; color:#cfe7ff; letter-spacing:.2px }
    .wrap { max-width:1100px; margin:0 auto; padding:24px }
    .top { display:flex; gap:12px; align-items:center; margin-bottom:16px }
    .pill { padding:6px 10px; border-radius:999px; background:#0f1b26; color:#cfe7ff; border:1px solid #183245 }
    .grid { display:grid; gap:14px }
    .g2 { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .g3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    .card { background:var(--card); border:1px solid #1e2a38; border-radius:12px; padding:14px }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    label { display:block; font-size:.86rem; color:#b6cadb; margin-bottom:6px }
    input[type=text], input[type=number], input[type=time], input[type=datetime-local], select, textarea {
      width:100%; background:#0d141d; color:#eaf2f9; border:1px solid #213246; border-radius:8px; padding:8px 10px;
    }
    input[type=checkbox] { transform: translateY(1px) }
    .btn { background:#0e2436; color:#eaf2f9; border:1px solid #2a4764; border-radius:8px; padding:8px 12px; cursor:pointer }
    .btn:hover { background:#133149 }
    .btn.green { background:#123720; border-color:#27643c }
    .btn.red { background:#3b1420; border-color:#6a2a3b }
    .btn.gray { background:#0f1621; border-color:#2b3a50 }
    .muted { color:var(--muted) }
    .table { width:100%; border-collapse: collapse; }
    .table th, .table td { text-align:left; border-bottom:1px solid #203044; padding:8px 6px; font-size:.92rem }
    .badge { padding:2px 8px; border-radius:8px; background:#0f1b26; border:1px solid #203044; color:#9ec6ff; font-size:.78rem }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .sep { height:1px; background:#203044; margin:10px -14px }
    .foot { margin-top:20px; color:#88a1b6; font-size:.85rem }
    img.plot { width:100%; border-radius:10px; border:1px solid #1f2c3a; background:#0a0f16 }
    .flex { display:flex; gap:10px; align-items:center }
    .right { margin-left:auto }
    .hint { font-size:.8rem; color:#8fb0c8 }
    .error { color:#ff9da9 }
    .good { color:#7ee787 }
    details summary { cursor:pointer }
    code { background:#0c1520; padding:2px 6px; border-radius:6px; border:1px solid #213246 }
  </style>
</head>
<body>
<div class="wrap">

  <div class="top">
    <h1>Pocket Option Signals</h1>
    <span class="pill">TZ: {{ tz or 'UTC' }}</span>
    {% if within is defined %}
      <span class="pill">{{ 'Within window' if within else 'Outside window' }}</span>
    {% endif %}
    {% if now %}<span class="pill">{{ now }}</span>{% endif %}
    <span class="right"></span>
    {% if session.get('admin') %}
      <form method="get" action="{{ url_for('dashboard.logout') }}"><button class="btn gray">Logout</button></form>
    {% endif %}
  </div>

  {# ----------------------------- VIEW: LOGIN ------------------------------ #}
  {% if view == 'login' %}
    <div class="grid g2">
      <div class="card">
        <h2>Admin Login</h2>
        <form method="post">
          <label>Password</label>
          <input type="password" name="password" placeholder="admin123">
          <div style="height:10px"></div>
          <button class="btn green">Login</button>
        </form>
        <div class="foot">Set <code>ADMIN_PASSWORD</code> in env to change it.</div>
      </div>
      <div class="card">
        <h2>Status</h2>
        <div class="muted">Server time: {{ now or '' }}</div>
        <div class="muted">Timezone: {{ tz or 'UTC' }}</div>
      </div>
    </div>

  {# ----------------------------- VIEW: INDEX ------------------------------ #}
  {% elif view == 'index' %}
    <div class="grid g2">
      <div class="card">
        <h2>Welcome</h2>
        <p class="muted">This service generates and delivers binary options signals with screenshot backtests, Telegram routing, and per-user limits.</p>
        <p><a class="btn" href="{{ url_for('dashboard.login') }}">Go to Login</a></p>
      </div>
      <div class="card">
        <h2>Uptime</h2>
        <p class="muted">Health endpoint: <code>/ _up</code></p>
      </div>
    </div>

  {# --------------------------- VIEW: DASHBOARD ---------------------------- #}
  {% elif view == 'dashboard' %}
  <div class="grid g2">

    {# -------- Settings: window + live defaults -------- #}
    <div class="card">
      <h2>Trading Window & Live Defaults</h2>
      {% set w = window or {} %}
      <form method="post" action="{{ url_for('dashboard.update_window') }}">
        <div class="grid g3">
          <div>
            <label>Start</label>
            <input type="time" name="start" value="{{ w.get('start','08:00') }}">
          </div>
          <div>
            <label>End</label>
            <input type="time" name="end" value="{{ w.get('end','17:00') }}">
          </div>
          <div>
            <label>Timezone</label>
            <input type="text" name="timezone" value="{{ w.get('timezone', tz or 'UTC') }}" placeholder="America/Port_of_Spain">
          </div>
        </div>
        <div class="sep"></div>
        <div class="grid g3">
          <div>
            <label>Live TF</label>
            <select name="live_tf">
              {% for x in ['M1','M2','M3','M5','M10','M15','M30','H1','H4','D1'] %}
                <option value="{{x}}" {% if (live_tf or 'M5')==x %}selected{% endif %}>{{x}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Live Expiry</label>
            <select name="live_expiry">
              {% for x in ['1m','3m','5m','10m','30m','1h','4h'] %}
                <option value="{{x}}" {% if (live_expiry or '5m')==x %}selected{% endif %}>{{x}}</option>
              {% endfor %}
            </select>
          </div>
          <div style="align-self:end">
            <button class="btn green">Save</button>
          </div>
        </div>
      </form>
    </div>

    {# -------- Strategies + Custom rules -------- #}
    <div class="card">
      <h2>Strategies</h2>
      {% set s_all = strategies_all or {'BASE':{'enabled':1},'TREND':{'enabled':0},'CHOP':{'enabled':0}} %}
      {% set s_core = strategies or {} %}
      <form method="post" action="{{ url_for('dashboard.update_strategies') }}">
        <div class="row">
          {% for name in ['BASE','TREND','CHOP'] %}
            <label class="flex"><input type="checkbox" name="s_{{name}}" {% if (s_all.get(name) or {}).get('enabled') %}checked{% endif %}> &nbsp; {{name}}</label>
          {% endfor %}
          {% for i in [1,2,3] %}
            <label class="flex"><input type="checkbox" name="s_CUSTOM{{i}}" {% if (s_all.get('CUSTOM'~i) or {}).get('enabled') %}checked{% endif %}> &nbsp; CUSTOM{{i}}</label>
          {% endfor %}
          <span class="right"></span>
          <button class="btn green">Save</button>
        </div>
      </form>
      <div class="sep"></div>

      {# Custom blocks #}
      {% for c in customs or [] %}
      <details {% if c.get('enabled') %}open{% endif %}>
        <summary>Custom {{c._idx}} &nbsp; {% if c.get('enabled') %}<span class="badge">enabled</span>{% else %}<span class="badge">disabled</span>{% endif %}</summary>
        <div style="height:10px"></div>
        <form method="post" action="{{ url_for('dashboard.update_custom') }}">
          <input type="hidden" name="slot" value="{{c._idx}}">
          <div class="row">
            <label class="flex"><input type="checkbox" name="enabled" {% if c.get('enabled') %}checked{% endif %}> &nbsp; Enabled</label>
            <label>Mode
              <select name="mode">
                {% for m in ['SIMPLE','JSON'] %}
                  <option value="{{m}}" {% if (c.get('mode','SIMPLE')==m) %}selected{% endif %}>{{m}}</option>
                {% endfor %}
              </select>
            </label>
            <label>Lookback <input type="number" name="lookback" value="{{ c.get('lookback',3) }}"></label>
            <label>Tol % <input type="number" step="0.01" name="tol_pct" value="{{ c.get('tol_pct',0.1) }}"></label>
            <span class="right"></span>
            <button class="btn">Save Custom {{c._idx}}</button>
          </div>
          <div class="grid g2" style="margin-top:10px">
            <div>
              <label>Simple BUY (natural)</label>
              <input type="text" name="simple_buy" value="{{ c.get('simple_buy','') }}" placeholder="RSI(14)&lt;30 AND K&gt;D">
            </div>
            <div>
              <label>Simple SELL (natural)</label>
              <input type="text" name="simple_sell" value="{{ c.get('simple_sell','') }}" placeholder="RSI(14)&gt;70 AND K&lt;D">
            </div>
            <div>
              <label>Buy rule JSON</label>
              <textarea name="buy_rule_json" rows="4" class="mono">{{ c.get('buy_rule')|tojson }}</textarea>
            </div>
            <div>
              <label>Sell rule JSON</label>
              <textarea name="sell_rule_json" rows="4" class="mono">{{ c.get('sell_rule')|tojson }}</textarea>
            </div>
          </div>
        </form>
      </details>
      <div class="sep"></div>
      {% endfor %}
    </div>

    {# -------- Symbols (PO/Deriv + text, with safe ['pairs']) -------- #}
    <div class="card">
      <h2>Symbols</h2>
      <form method="post" action="{{ url_for('dashboard.update_symbols') }}">
        <div class="grid g2">
          <div>
            <label>Pocket Option majors</label>
            <select name="symbols_po_multi" multiple size="8">
              {% for s in available_groups[1]['pairs'] %}
                <option value="{{s}}" {% if s in (symbols_raw or []) %}selected{% endif %}>{{s}}</option>
              {% endfor %}
            </select>
            <div class="hint">Hold Ctrl/Cmd to multi-select.</div>
          </div>
          <div>
            <label>Deriv (frx*)</label>
            <select name="symbols_deriv_multi" multiple size="8">
              {% for s in available_groups[0]['pairs'] %}
                <option value="{{s}}" {% if s in (symbols_raw or []) or s in (active_symbols or []) %}selected{% endif %}>{{s}}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="grid g2" style="margin-top:10px">
          <div>
            <label>Free text (CSV or space separated)</label>
            <input type="text" name="symbols_text" placeholder="EURUSD, GBPUSD, frxEURUSD" value="{{ (symbols_raw or [])|join(', ') }}">
          </div>
          <div style="align-self:end">
            <label class="flex"><input type="checkbox" name="convert_po"> &nbsp; Convert PO â†’ Deriv</label>
            <button class="btn green">Save Symbols</button>
          </div>
        </div>
      </form>
    </div>

    {# -------- Indicators (full from INDICATOR_SPECS) -------- #}
    <div class="card">
      <h2>Indicators</h2>
      <form method="post" action="{{ url_for('dashboard.update_indicators') }}">
        <div class="grid g3">
          {% for key, spec in (specs or {}).items() %}
          <div class="card" style="background:#0f141c; border-color:#1b2a3a">
            <div class="row">
              <strong>{{ spec.label or key|upper }}</strong>
              <span class="right"></span>
              <label class="flex"><input type="checkbox" name="ind_{{key}}_enabled"
                  {% if (indicators or {}).get(key,{}).get('enabled') %}checked{% endif %}> &nbsp; Enabled</label>
            </div>
            <div style="height:8px"></div>
            {% for pname, pdef in (spec.params or {}).items() %}
              <label>{{pname}}
                <input type="text" name="ind_{{key}}_{{pname}}" value="{{ (indicators or {}).get(key,{}).get(pname, pdef) }}">
              </label>
            {% endfor %}
          </div>
          {% endfor %}
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn green">Save Indicators</button>
          <span class="hint">These feed both backtest plots and live rules.</span>
        </div>
      </form>
    </div>

    {# -------- Backtest -------- #}
    <div class="card">
      <h2>Backtest</h2>
      <form method="post" action="{{ url_for('dashboard.backtest') }}" enctype="multipart/form-data">
        <div class="grid g3">
          <div>
            <label>TF</label>
            <select name="bt_tf">
              {% for x in ['M1','M2','M3','M5','M10','M15','M30','H1','H4','D1'] %}
                <option value="{{x}}">{{x}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Expiry</label>
            <select name="bt_expiry">
              {% for x in ['1m','3m','5m','10m','30m','1h','4h'] %}
                <option value="{{x}}" {% if (bt or {}).get('expiry')==x %}selected{% endif %}>{{x}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Strategy</label>
            <select name="bt_strategy">
              {% for s in ['BASE','TREND','CHOP','CUSTOM1','CUSTOM2','CUSTOM3'] %}
                <option value="{{s}}">{{s}}</option>
              {% endfor %}
            </select>
          </div>
        </div>

        <div class="grid g2" style="margin-top:10px">
          <div>
            <label>Symbols (space/CSV) â€” leave blank to use saved</label>
            <input type="text" name="bt_symbols" placeholder="frxEURUSD, frxGBPUSD ...">
          </div>
          <div class="row" style="margin-top:24px">
            <label class="flex"><input type="checkbox" name="convert_po_bt"> &nbsp; Convert PO â†’ Deriv</label>
            <label class="flex"><input type="checkbox" name="use_server"> &nbsp; Fetch fresh from server helper</label>
            <label>Count<input type="number" name="bt_count" value="300"></label>
            <button class="btn">Run Backtest</button>
          </div>
        </div>

        <div class="grid g2" style="margin-top:10px">
          <div>
            <label>CSV Upload (time, open, high, low, close)</label>
            <input type="file" name="bt_csv" accept=".csv">
          </div>
        </div>
      </form>

      <div class="sep"></div>

      {% if bt and bt.get('plot_name') %}
        <div class="row">
          <strong>Result:</strong>
          <span class="badge">TF {{ bt.tf }}</span>
          <span class="badge">Expiry {{ bt.expiry }}</span>
          <span class="badge">Strategy {{ bt.strategy }}</span>
          <span class="right"></span>
          <a class="btn gray" href="{{ url_for('dashboard.backtest_last_json') }}">JSON</a>
          <a class="btn gray" href="{{ url_for('dashboard.backtest_last_csv') }}">CSV</a>
        </div>
        <div style="height:8px"></div>
        <img class="plot" id="bt_plot" src="{{ url_for('dashboard.plot_file', name=bt.plot_name) }}?t={{ now }}" alt="backtest plot">
        <div class="hint">Markers show entries; shaded span shows expiry window.</div>
        {% if bt.get('warnings') %}
          <div class="error">Warnings: {{ bt.warnings|join('; ') }}</div>
        {% endif %}
        {% if bt.get('summary') %}
          <div class="grid g3" style="margin-top:10px">
            <div class="card">
              <div class="muted">Trades</div>
              <div class="good" style="font-size:1.3rem">{{ bt.summary.trades }}</div>
            </div>
            <div class="card">
              <div class="muted">Wins / Losses / Draws</div>
              <div>{{ bt.summary.wins }} / {{ bt.summary.losses }} / {{ bt.summary.draws }}</div>
            </div>
            <div class="card">
              <div class="muted">Win Rate</div>
              <div>{{ '%.2f'|format(bt.summary.winrate or 0.0) }}%</div>
            </div>
          </div>
        {% endif %}
      {% else %}
        <div class="hint">Run a backtest to see a screenshot with candles + indicators + entries/expiry.</div>
      {% endif %}
    </div>

    {# -------- Live engine & tally -------- #}
    <div class="card">
      <h2>Live Engine</h2>
      <div class="row">
        <button class="btn green" onclick="liveStart()">Start</button>
        <button class="btn red" onclick="liveStop()">Stop</button>
        <button class="btn" onclick="liveStatus()">Status</button>
        <button class="btn" onclick="liveTally()">Tally</button>
        <span class="right"></span>
        <label class="flex">Debug:
          <select id="dbg" onchange="liveDebug(this.value)">
            <option value="off">off</option>
            <option value="on">on</option>
          </select>
        </label>
      </div>
      <div id="live_out" class="hint" style="margin-top:8px"></div>
    </div>

    {# -------- Telegram diag -------- #}
    <div class="card">
      <h2>Telegram</h2>
      <div class="row">
        <button class="btn" onclick="tgTest()">Send Test</button>
        <button class="btn" onclick="tgDiag()">Diag</button>
      </div>
      <pre id="tg_out" class="mono" style="white-space:pre-wrap; margin-top:8px"></pre>
    </div>

    {# -------- Users (tiers + expiry) -------- #}
    <div class="card">
      <h2>Users</h2>
      <form method="post" action="{{ url_for('dashboard.users_add') }}">
        <div class="grid g3">
          <div>
            <label>Telegram ID</label>
            <input type="text" name="telegram_id" placeholder="123456789">
          </div>
          <div>
            <label>Tier</label>
            <select name="tier">
              <option value="free">free (3/day)</option>
              <option value="basic">basic (6/day)</option>
              <option value="pro">pro (15/day)</option>
              <option value="vip">vip (unlimited)</option>
            </select>
          </div>
          <div>
            <label>Expires at (optional)</label>
            <input type="datetime-local" name="expires_at">
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn green">Save / Update User</button>
        </div>
      </form>

      <div style="height:10px"></div>
      <table class="table">
        <thead><tr><th>Telegram</th><th>Tier</th><th>Expires</th><th></th></tr></thead>
        <tbody>
        {% for u in users or [] %}
          <tr>
            <td class="mono">{{ u.telegram_id }}</td>
            <td>{{ u.tier }}</td>
            <td>{{ u.expires_at or '' }}</td>
            <td>
              <form method="post" action="{{ url_for('dashboard.users_delete') }}">
                <input type="hidden" name="telegram_id" value="{{ u.telegram_id }}">
                <button class="btn red">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
      <div class="hint">Caps enforced in live engine: free=3, basic=6, pro=15, vip=âˆž per day per user.</div>
    </div>

    {# -------- Deriv fetch helper (optional) -------- #}
    <div class="card">
      <h2>Deriv Fetch (optional helper)</h2>
      <form method="post" action="{{ url_for('dashboard.deriv_fetch') }}">
        <div class="grid g3">
          <div>
            <label>TF</label>
            <select name="fetch_tf">
              {% for x in ['M1','M2','M3','M5','M10','M15','M30','H1','H4','D1'] %}
                <option value="{{x}}">{{x}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Count</label>
            <input type="number" name="fetch_count" value="300">
          </div>
          <div style="align-self:end">
            <label class="flex"><input type="checkbox" name="convert_po_fetch"> &nbsp; Convert PO â†’ Deriv</label>
            <button class="btn">Fetch</button>
          </div>
        </div>
        <div style="margin-top:8px">
          <label>Symbols (CSV/space)</label>
          <input type="text" name="fetch_symbols" placeholder="frxEURUSD frxGBPUSD">
        </div>
      </form>
      <div class="hint">If <code>data_fetch.py</code> isnâ€™t present, youâ€™ll see a friendly error.</div>
    </div>

  </div> {# grid g2 #}

  {% endif %}

  <div class="foot">Â© {{ (now or '')[:4] }} â€¢ Pocket Option Signals â€¢ <span class="muted">/dashboard</span></div>
</div>

<script>
async function liveStart(){ const r=await fetch("{{ url_for('dashboard.live_start') }}"); document.getElementById('live_out').textContent=await r.text(); }
async function liveStop(){ const r=await fetch("{{ url_for('dashboard.live_stop') }}"); document.getElementById('live_out').textContent=await r.text(); }
async function liveStatus(){ const r=await fetch("{{ url_for('dashboard.live_status') }}"); document.getElementById('live_out').textContent=await r.text(); }
async function liveTally(){ const r=await fetch("{{ url_for('dashboard.live_tally') }}"); document.getElementById('live_out').textContent=await r.text(); }
async function liveDebug(v){ const r=await fetch("{{ url_for('dashboard.live_debug', state='__X__') }}".replace("__X__", v)); document.getElementById('live_out').textContent=await r.text(); }
async function tgTest(){ const r=await fetch("{{ url_for('dashboard.telegram_test') }}"); document.getElementById('tg_out').textContent=await r.text(); }
async function tgDiag(){ const r=await fetch("{{ url_for('dashboard.telegram_diag') }}"); document.getElementById('tg_out').textContent=await r.text(); }
</script>
</body>
</html>
