<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pocket-Option Signals — Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0d11; --panel:#11141a; --panel2:#0e131c; --muted:#92a0b8; --text:#e8edf7; --acc:#3aa0ff; --ok:#17c964; --warn:#ffcc00; --err:#ff4d4f;
      --br:14px;
    }
    html,body{margin:0;padding:0;background:#0a0c10;color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--acc);text-decoration:none}
    .wrap{max-width:1280px;margin:0 auto;padding:18px}
    .grid{display:grid;gap:14px}
    .g-2{grid-template-columns:2fr 1fr}
    .g-3{grid-template-columns:repeat(3,1fr)}
    .card{background:var(--panel);border-radius:var(--br);padding:14px;border:1px solid rgba(255,255,255,.08)}
    .card h3{margin:0 0 10px 0;font-size:16px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1}
    label{display:inline-block;margin:6px 0 4px 0;color:#cfd6e7}
    input[type=text], input[type=number], input[type=time], select, textarea{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
      background:#0d1117;color:var(--text);outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .btn{display:inline-block;background:#1a2233;color:#eaf1ff;border:1px solid rgba(255,255,255,.15);padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#242f46}
    .btn-acc{background:#1463b8;border-color:#237ad7}
    .btn-acc:hover{background:#1a6ed0}
    .btn-ok{background:#0e3b21;border-color:#0b5;color:#aef1c7}
    .btn-err{background:#3a1212;border-color:#6b1c1c;color:#ffb1b1}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:12px;color:#cbd4ea}
    .flash{padding:10px 12px;border-radius:10px;margin:10px 0}
    .flash-ok{background:#062a17;border:1px solid #0b4;color:#baf7d2}
    .flash-err{background:#2a0c0c;border:1px solid #b33;color:#ffc9c9}
    .kvs{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px}
    .kvs .kv{background:#0f1420;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px}
    .kv .k{font-size:12px;color:#aab3c7}
    .kv .v{font-size:16px;margin-top:2px}
    .right-sticky{position:sticky;top:14px}
    .legend{font-size:12px;color:#96a1b8}
    .small{font-size:12px}
    .list{display:flex;flex-wrap:wrap;gap:6px}
    .list .item{padding:6px 8px;border-radius:10px;background:#0f1420;border:1px solid rgba(255,255,255,.08)}
    img.plot{max-width:100%;border-radius:12px;border:1px solid rgba(255,255,255,.1)}
    hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:12px 0}
    .ind-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .ind-card{background:var(--panel2);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px}
    .ind-title{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .two-col{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .note{font-size:12px;color:#9fb0cc}
    .center{display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
<div class="wrap">

  <!-- Header -->
  <div class="row" style="align-items:center">
    <div style="flex:1">
      <h2 style="margin:0 0 2px 0">Pocket-Option Signals</h2>
      <div class="muted small">
        Local: <b>{{ now_local }}</b> • TZ: <b>{{ TZ }}</b>
        • PO time (UTC): <span id="utcNow">—</span>
        • Window: <span class="pill">{{ 'OPEN' if window_ok else 'CLOSED' }}</span>
      </div>
      <div class="muted small" id="candlesInfo">TF: <b id="tfLbl">—</b> • Next candle in: <b id="cTimer">—</b> • Expiry ETA: <b id="expEta">—</b></div>
    </div>
    <div>
      <a class="btn" href="{{ url_for('dashboard.home') }}">Home</a>
      <a class="btn btn-acc" href="{{ url_for('dashboard.view') }}">Dashboard</a>
    </div>
  </div>

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
        <div class="flash {{ 'flash-err' if cat=='error' else 'flash-ok' }}">{{ msg }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="grid g-2">
    <!-- LEFT column -->
    <div>

      <!-- Trading window & strategy defaults -->
      <form class="card" method="post" action="{{ url_for('dashboard.view') }}">
        <h3>Trading Window & Defaults</h3>
        <div class="row">
          <div>
            <label>Start</label>
            <input type="time" name="window_start" value="{{ (cfg.window_start or '08:00') if cfg else '08:00' }}">
          </div>
          <div>
            <label>End</label>
            <input type="time" name="window_end" value="{{ (cfg.window_end or '17:00') if cfg else '17:00' }}">
          </div>
          <div>
            <label>Use Deriv server fetch</label>
            <select name="use_deriv_fetch">
              <option value="" {{ '' if not cfg.get('use_deriv_fetch') else '' }}>OFF</option>
              <option value="1" {{ 'selected' if cfg.get('use_deriv_fetch') else '' }}>ON</option>
            </select>
          </div>
          <div>
            <label>Deriv candles (target)</label>
            <input type="number" name="deriv_count" value="{{ cfg.get('deriv_count',300) }}">
          </div>
        </div>
        <hr>
        <h3 style="margin-top:0">Strategies</h3>
        <div class="list">
          {% for s in ["BASE","TREND","CHOP","CUSTOM1","CUSTOM2","CUSTOM3"] %}
            <label class="item small">
              <input type="checkbox" name="strategy_{{s}}" {{ 'checked' if cfg.get(s) else '' }}> {{s}}
            </label>
          {% endfor %}
        </div>
        <div style="margin-top:10px">
          <button class="btn btn-acc" type="submit">Save Window & Strategy Toggles</button>
        </div>
      </form>

      <!-- Indicators -->
      <form class="card" method="post" action="{{ url_for('dashboard.view') }}">
        <h3>Indicators</h3>
        <div class="ind-grid">
          {% for key, spec in ind_specs.items() %}
            {% set block = (cfg.indicators or {}).get(key, {}) %}
            <div class="ind-card">
              <div class="ind-title">
                <input type="checkbox" name="ind_{{key}}" {{ 'checked' if block.get('enabled') else '' }}>
                <div>
                  <div><b>{{ spec.title or key }}</b></div>
                  <div class="legend muted small">{{ key }} • {{ spec.panel }}</div>
                </div>
              </div>
              {% if spec.fields %}
              <div class="two-col">
                {% for fname, default in spec.fields.items() %}
                  {% set val = block.get(fname, default) %}
                  <div>
                    <label class="small">{{ fname }}</label>
                    <input type="text" name="ind_{{
                      key
                    }}_{{
                      fname
                    }}" value="{{ val }}">
                  </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <div style="margin-top:10px">
          <button class="btn btn-acc" type="submit">Save Indicators</button>
        </div>
        <p class="note" style="margin-top:6px">Only <u>enabled</u> indicators are drawn on screenshots and respected by strategies/custom rules.</p>
      </form>

      <!-- Custom rules -->
      <form class="card" method="post" action="{{ url_for('dashboard.view') }}">
        <h3>Custom Rules (text)</h3>
        <div class="row">
          <div>
            <label>CUSTOM 1</label>
            <textarea name="custom1_rules" placeholder="e.g. RSI &lt; 30 AND StochK cross up">{{ cfg.get('custom1_rules','') }}</textarea>
          </div>
          <div>
            <label>CUSTOM 2</label>
            <textarea name="custom2_rules" placeholder="e.g. SMA(50) cross above SMA(200)">{{ cfg.get('custom2_rules','') }}</textarea>
          </div>
          <div>
            <label>CUSTOM 3</label>
            <textarea name="custom3_rules" placeholder="e.g. Supertrend flip + RSI(14) &gt; 55">{{ cfg.get('custom3_rules','') }}</textarea>
          </div>
        </div>
        <div style="margin-top:10px">
          <button class="btn btn-acc" type="submit">Save Custom Rules</button>
        </div>
        <p class="note">JSON rule boxes can be added later—this build stores plain text rules (visible for auditing) while the engine uses your enabled indicators + chosen strategy.</p>
      </form>

      <!-- Backtest -->
      <div class="card">
        <h3>Backtest & Screenshot</h3>
        <div class="row">
          <div>
            <label>Symbols (comma/space, PO or Deriv)</label>
            <input id="bt_symbols" type="text" placeholder="EURUSD, GBPUSD or frxEURUSD ..." />
            <label class="small"><input id="bt_convert" type="checkbox"> Convert PO→Deriv</label>
          </div>
        </div>
        <div class="row">
          <div>
            <label>TF</label>
            <select id="bt_tf">
              {% for t in ["M1","M2","M3","M5","M10","M15","M30","H1","H4","D1"] %}
                <option value="{{t}}">{{t}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Expiry</label>
            <select id="bt_expiry">
              {% for e in ["1m","3m","5m","10m","30m","1h","4h"] %}
                <option value="{{e}}">{{e}}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label>Use Deriv fetch</label>
            <select id="bt_use_deriv">
              <option value="">OFF</option>
              <option value="1" {{ 'selected' if cfg.get('use_deriv_fetch') else '' }}>ON</option>
            </select>
          </div>
          <div>
            <label>Candles</label>
            <input id="bt_target" type="number" value="{{ cfg.get('deriv_count',300) }}">
          </div>
        </div>
        <div class="row">
          <div>
            <label>Upload CSV</label>
            <input id="bt_csv" type="file" accept=".csv" />
          </div>
          <div>
            <label>Strategy</label>
            <select id="bt_strategy">
              {% for s in ["BASE","TREND","CHOP","CUSTOM1","CUSTOM2","CUSTOM3"] %}
                <option value="{{s}}">{{s}}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div style="margin-top:10px">
          <button class="btn btn-acc" id="btnRunBt">Run Backtest & Show Screenshot</button>
          <span class="note">Plot shows enabled indicators + BUY/SELL markers + shaded expiry.</span>
        </div>
        <hr>
        <div id="btResult" class="small muted">—</div>
        <div id="btImgWrap" style="margin-top:10px;display:none">
          <img id="btImg" class="plot" alt="Backtest plot">
        </div>
      </div>

      <!-- Telegram -->
      <div class="card">
        <h3>Telegram</h3>
        <div class="row">
          <div style="flex:2">
            <label>Message</label>
            <textarea id="tg_text" placeholder="Type a message to send..."></textarea>
          </div>
          <div style="flex:1">
            <label>Tier</label>
            <select id="tg_tier">
              <option value="all">All</option>
              <option value="free">Free</option>
              <option value="basic">Basic</option>
              <option value="pro">Pro</option>
              <option value="vip">VIP</option>
            </select>
            <div style="margin-top:10px">
              <button class="btn btn-ok" id="btnTgSend">Send</button>
              <button class="btn" id="btnTgTest">Send Test (All)</button>
            </div>
          </div>
        </div>
        <div id="tgResult" class="small muted" style="margin-top:8px">—</div>
      </div>

    </div>

    <!-- RIGHT column -->
    <div class="right-sticky">
      <!-- Live Engine -->
      <div class="card">
        <h3>Live Engine</h3>
        <div class="row">
          <button class="btn btn-ok" id="btnStart">Start</button>
          <button class="btn btn-err" id="btnStop">Stop</button>
          <button class="btn" id="btnDbgOn">Debug ON</button>
          <button class="btn" id="btnDbgOff">Debug OFF</button>
        </div>
        <hr>
        <div class="kvs">
          <div class="kv"><div class="k">State</div><div class="v" id="lv_state">—</div></div>
          <div class="kv"><div class="k">Free</div><div class="v" id="lv_free">0</div></div>
          <div class="kv"><div class="k">Basic</div><div class="v" id="lv_basic">0</div></div>
          <div class="kv"><div class="k">Pro</div><div class="v" id="lv_pro">0</div></div>
          <div class="kv"><div class="k">VIP</div><div class="v" id="lv_vip">0</div></div>
          <div class="kv"><div class="k">All</div><div class="v" id="lv_all">0</div></div>
        </div>
        <p class="note small">Daily caps enforced in engine: Free=3, Basic=6, Pro=15, VIP=∞.</p>
      </div>

      <!-- Quick Links -->
      <div class="card">
        <h3>Quick Links</h3>
        <div class="list">
          <a class="item" href="{{ url_for('dashboard.live_status') }}" target="_blank">/live/status</a>
          <a class="item" href="{{ url_for('dashboard.live_tally') }}" target="_blank">/live/tally</a>
          <a class="item" href="{{ url_for('dashboard.api_indicators') }}" target="_blank">/api/indicators</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ---------- helpers ----------
function qs(id){ return document.getElementById(id); }
async function post(url, data, asForm=false){
  if(asForm){
    const fd = new FormData();
    for(const k in data) fd.append(k, data[k]);
    const r = await fetch(url, { method:'POST', body: fd });
    return r.json();
  }else{
    const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data||{}) });
    return r.json();
  }
}
async function get(url){ const r = await fetch(url); return r.json(); }

// ---------- UTC clock ----------
function tickUTC(){
  const d=new Date();
  qs('utcNow').textContent = new Date(d.toISOString()).toISOString().slice(0,19).replace('T',' ');
}
setInterval(tickUTC, 1000); tickUTC();

// ---------- Candle timer & expiry ETA ----------
const tfToSec = {M1:60,M2:120,M3:180,M5:300,M10:600,M15:900,M30:1800,H1:3600,H4:14400,D1:86400};
const expToMin = {"1m":1,"3m":3,"5m":5,"10m":10,"30m":30,"1h":60,"4h":240};
function updateTimers(){
  const tf = (qs('bt_tf')?.value || 'M1');
  const expiry = (qs('bt_expiry')?.value || '5m').toLowerCase();
  const sec = tfToSec[tf] || 60;
  qs('tfLbl').textContent = tf;
  const now = Date.now()/1000;
  const next = Math.ceil(now/sec)*sec;
  const rem = Math.max(0, Math.floor(next - now));
  const m = String(Math.floor(rem/60)).padStart(2,'0');
  const s = String(rem%60).padStart(2,'0');
  qs('cTimer').textContent = `${m}:${s}`;
  const expEta = new Date((next + (expToMin[expiry]||5)*60)*1000);
  qs('expEta').textContent = expEta.toISOString().slice(11,19) + 'Z';
}
setInterval(updateTimers, 250); updateTimers();

// ---------- Live engine controls ----------
async function refreshLive(){
  const s = await get('/live/status');
  const st = s.running ? 'RUNNING' : 'STOPPED';
  qs('lv_state').textContent = st + (s.debug ? ' • DEBUG' : '');
  const t = await get('/live/tally');
  qs('lv_free').textContent  = t.free ?? t.by_tier?.free ?? 0;
  qs('lv_basic').textContent = t.basic ?? t.by_tier?.basic ?? 0;
  qs('lv_pro').textContent   = t.pro ?? t.by_tier?.pro ?? 0;
  qs('lv_vip').textContent   = t.vip ?? t.by_tier?.vip ?? 0;
  qs('lv_all').textContent   = t.all ?? t.total ?? 0;
}
qs('btnStart').onclick = async()=>{ await post('/live/start',{}); refreshLive(); };
qs('btnStop').onclick  = async()=>{ await post('/live/stop',{});  refreshLive(); };
qs('btnDbgOn').onclick = async()=>{ await post('/live/start',{}); s=await get('/live/status'); s.debug=true; await post('/live/start',{}); refreshLive(); };
qs('btnDbgOff').onclick= async()=>{ await post('/live/stop',{});  refreshLive(); };
setInterval(refreshLive, 4000); refreshLive();

// ---------- Backtest ----------
qs('btnRunBt').onclick = async (e)=>{
  e.preventDefault();
  const fd = new FormData();
  fd.append('symbols', qs('bt_symbols').value.trim());
  if(qs('bt_convert').checked) fd.append('convert_po_deriv','1');
  fd.append('tf', qs('bt_tf').value);
  fd.append('expiry', qs('bt_expiry').value);
  fd.append('use_deriv_fetch', qs('bt_use_deriv').value);
  fd.append('target', qs('bt_target').value);
  fd.append('strategy', qs('bt_strategy').value);
  const f = qs('bt_csv').files?.[0];
  if(f) fd.append('csv', f);

  const r = await fetch('/backtest', { method:'POST', body: fd });
  const js = await r.json().catch(()=>({ok:false,error:'Bad JSON'}));
  if(js.ok){
    qs('btResult').textContent = `OK — ${JSON.stringify(js.stats)}`;
    const p = js.plot || js.plot_url || js.plot_path;
    if(p){ qs('btImg').src = p; qs('btImgWrap').style.display = ''; }
  }else{
    qs('btResult').textContent = `Error — ${js.error || 'Unknown error'}`;
    qs('btImgWrap').style.display = 'none';
  }
};

// ---------- Telegram ----------
qs('btnTgSend').onclick = async (e)=>{
  e.preventDefault();
  const text = qs('tg_text').value.trim();
  const tier = qs('tg_tier').value;
  if(!text){ alert('Enter text'); return; }
  const fd = new FormData(); fd.append('text', text); fd.append('tier', tier);
  const r = await fetch('/telegram/send', { method:'POST', body: fd });
  const js = await r.json().catch(()=>({ok:false}));
  qs('tgResult').textContent = JSON.stringify(js);
};
qs('btnTgTest').onclick = async (e)=>{
  e.preventDefault();
  const fd = new FormData(); fd.append('text', '🧪 Dashboard test');
  const r = await fetch('/telegram/test', { method:'POST', body: fd });
  const js = await r.json().catch(()=>({ok:false}));
  qs('tgResult').textContent = JSON.stringify(js);
};
</script>
</body>
</html>
